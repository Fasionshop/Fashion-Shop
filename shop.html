<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Fashion - Shop</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Mitr:wght@300;400;500;600&display=swap" rel="stylesheet">
  
  <style>
    /* --- (CSS ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) --- */
    :root { --primary: #7A56D3; --bg: #f5f5f5; --white: #ffffff; --text: #333; }
    body { 
      font-family: 'Mitr', sans-serif; background-color: var(--bg); 
      margin: 0; padding-bottom: 70px; font-size: 16px; 
      user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;
    }
    
    /* --- (CSS ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤) --- */
    .search-bar {
      position: relative; /* (1) ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô relative ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ dropdown ‡∏≠‡∏¢‡∏π‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á */
    }
    
    #searchHistoryDropdown {
      display: none; /* (2) ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô */
      position: absolute;
      top: 110%; /* (3) ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ï‡πâ search bar */
      left: 0;
      width: 100%;
      background: white;
      border-radius: 5px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      z-index: 110; /* (4) ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á */
      max-height: 250px;
      overflow-y: auto;
      border: 1px solid #eee;
    }
    
    .history-item, .history-clear {
      padding: 10px 15px;
      cursor: pointer;
      font-size: 0.95rem;
      color: #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #f5f5f5;
    }
    
    .history-item:hover {
      background: #f9f9f9;
    }
    
    .history-item .history-text {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .history-item .remove-history-btn {
      font-size: 0.9rem;
      color: #aaa;
      cursor: pointer;
      padding: 5px;
    }
    .history-item .remove-history-btn:hover {
      color: #ff424f;
    }

    .history-clear {
      text-align: center;
      color: var(--primary);
      font-weight: 600;
      justify-content: center;
    }
    .history-clear:hover {
      background: #F3F0FF;
    }
    /* --- (‡∏à‡∏ö CSS ‡πÉ‡∏´‡∏°‡πà) --- */
    
    header { background: linear-gradient(-180deg, #7A56D3, #5E42A6); padding: 15px; position: sticky; top: 0; z-index: 100; display: flex; align-items: center; gap: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    /* .search-bar { flex-grow: 1; background: white; padding: 8px 15px; border-radius: 5px; display: flex; align-items: center; } (‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ö CSS ‡πÉ‡∏´‡∏°‡πà) */
    .search-bar { flex-grow: 1; background: white; padding: 8px 15px; border-radius: 5px; display: flex; align-items: center; }
    .search-bar input { border: none; outline: none; width: 100%; margin-left: 10px; font-family: 'Mitr', sans-serif; font-size: 1rem; }
    .icon-btn { color: white; font-size: 1.4rem; position: relative; cursor: pointer; display: flex; align-items: center; }
    .cart-badge { position: absolute; top: -8px; right: -8px; background: #ffe13c; color: var(--primary); font-size: 0.7rem; padding: 2px 6px; border-radius: 50%; font-weight: bold; border: 1px solid var(--primary); }
    .profile-menu { display: flex; align-items: center; gap: 8px; cursor: pointer; margin-left: 5px; color: white; }
    .header-avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; border: 2px solid white; background: #eee; }
    .header-name { font-size: 0.9rem; font-weight: 600; max-width: 80px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .category-bar { display: flex; overflow-x: auto; background: white; padding: 10px; gap: 15px; position: sticky; top: 60px; z-index: 90; }
    .cat-item { white-space: nowrap; padding: 5px 15px; border: 1px solid #ddd; border-radius: 20px; cursor: pointer; color: #666; transition: 0.3s; }
    .cat-item.active { border-color: var(--primary); color: var(--primary); background-color: #F3F0FF; font-weight: 600; }
    .product-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 10px; }
    @media (max-width: 768px) { .product-container { grid-template-columns: repeat(2, 1fr); } }
    
    /* --- ‚≠êÔ∏è [START] CSS ‡πÉ‡∏´‡∏°‡πà: ‡πÅ‡∏Å‡πâ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ --- */
    @media (max-width: 600px) {
      header {
        padding: 10px 12px; /* (1) ‡∏•‡∏î padding ‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤ */
        gap: 10px;         /* (2) ‡∏•‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô */
      }
      
      /* (3) ‡∏ã‡πà‡∏≠‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≤‡∏á‡πÜ ‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå (‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å) */
      .header-name {
        display: none;
      }
      
      /* (4) ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ */
      .icon-btn {
        font-size: 1.3rem; 
      }
      .profile-menu {
         margin-left: 0; /* ‡πÄ‡∏≠‡∏≤ margin ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° login ‡∏≠‡∏≠‡∏Å */
      }
      
      /* (5) ‡∏õ‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏´‡πâ‡∏ä‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô */
      .search-bar {
        padding: 8px 12px;
      }
      .search-bar input {
        margin-left: 8px;
      }
    }
    /* --- ‚≠êÔ∏è [END] CSS ‡πÉ‡∏´‡∏°‡πà --- */
    
    .product-card { background: white; border-radius: 5px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: transform 0.2s; display: flex; flex-direction: column; animation: fadeIn 0.5s; position: relative; }
    .product-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    .p-img { width: 100%; aspect-ratio: 1 / 1; background-color: #ddd; object-fit: cover; }
    .p-details { padding: 10px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; }
    .p-name { font-size: 0.9rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; margin-bottom: 5px; }
    .p-price { color: var(--primary); font-weight: bold; font-size: 1.1rem; }
    .p-stock { font-size: 0.75rem; color: #888; margin-top: 5px; }
    .p-btn { background: var(--primary); color: white; border: none; width: 100%; padding: 8px; margin-top: 10px; border-radius: 3px; cursor: pointer; font-family: 'Mitr'; }
    .p-btn:disabled { background: #ccc; }
    .fav-btn { position: absolute; top: 8px; right: 8px; width: 35px; height: 35px; background: rgba(255, 255, 255, 0.9); border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; color: #ccc; font-size: 1.2rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: 0.2s; border: none; z-index: 2; }
    .fav-btn:hover { transform: scale(1.1); }
    .fav-btn.active { color: #ff424f; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: flex-end; }
    .modal-content { background: white; width: 100%; max-width: 500px; border-radius: 20px 20px 0 0; padding: 20px; max-height: 85vh; overflow-y: auto; animation: slideUp 0.3s; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .confirm-modal-box { background: white; padding: 25px; border-radius: 10px; text-align: center; width: 90%; max-width: 350px; animation: popIn 0.3s; }
    @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .confirm-icon { font-size: 3rem; margin-bottom: 15px; display: block; }
    .confirm-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; color: #333; }
    .confirm-desc { font-size: 0.95rem; color: #666; margin-bottom: 20px; }
    .confirm-actions { display: flex; gap: 10px; justify-content: center; }
    .btn-confirm-action { flex: 1; padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-family: 'Mitr'; font-weight: 600; }
    .btn-yes { background: var(--primary); color: white; }
    .btn-no { background: #eee; color: #333; }
    .btn-ok { background: #4CAF50; color: white; width: 100%; }
    .cart-item { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: 15px 0; }
    
    /* ‚≠êÔ∏è‚≠êÔ∏è [‡πÄ‡∏û‡∏¥‡πà‡∏°] CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ ‚≠êÔ∏è‚≠êÔ∏è */
    .cart-item-img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 5px;
      margin-right: 15px;
      background-color: #f0f0f0; /* ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏£‡∏π‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ä‡πâ‡∏≤ */
      flex-shrink: 0; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏£‡∏π‡∏õ‡∏´‡∏î‡∏ï‡∏±‡∏ß */
    }
    
    .cart-item-info { flex-grow: 1; }
    .cart-item-controls { display: flex; align-items: center; gap: 10px; }
    .mini-qty-box { display: flex; align-items: center; border: 1px solid #ddd; border-radius: 4px; margin-top: 5px; width: fit-content; }
    .mini-qty-btn { width: 25px; height: 25px; border: none; background: #f8f8f8; cursor: pointer; color: #555; display: flex; align-items: center; justify-content: center; }
    .mini-qty-btn:hover { background: #eee; }
    .mini-qty-val { width: 30px; text-align: center; font-size: 1rem; font-weight: 600; }
    .close-btn { float: right; font-size: 1.5rem; cursor: pointer; }
    .checkout-btn { background: var(--primary); color: white; width: 100%; padding: 15px; border: none; font-size: 1.2rem; margin-top: 15px; border-radius: 5px; font-family: 'Mitr', sans-serif; font-weight: 600; }
    .order-card { border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #fff; }
    .order-header { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px; font-size: 0.95rem; color: #555; }
    .order-status { font-weight: 600; color: var(--primary); }
    .order-items { font-size: 0.95rem; color: #333; }
    
    /* ‚≠êÔ∏è‚≠êÔ∏è [START] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç CSS .order-total ‚≠êÔ∏è‚≠êÔ∏è */
    .order-total { 
      display: flex; /* üëà [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] */
      justify-content: space-between; /* üëà [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] */
      align-items: center; /* üëà [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] */
      font-weight: 600; 
      font-size: 1.2rem; 
      color: var(--primary); 
      margin-top: 10px; 
    }
    .order-total > span { /* üëà [‡πÉ‡∏´‡∏°‡πà] ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢ */
      font-size: 1.1rem;
    }
    /* ‚≠êÔ∏è‚≠êÔ∏è [END] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç CSS .order-total ‚≠êÔ∏è‚≠êÔ∏è */

    .item-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
    
    /* ‚≠êÔ∏è‚≠êÔ∏è [START] CSS ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‚≠êÔ∏è‚≠êÔ∏è */
    .order-total-actions { /* üëà [‡πÉ‡∏´‡∏°‡πà] */
      display: flex;
      gap: 10px;
    }
    
    .btn-cancel-order {
      background: #ff424f;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-family: 'Mitr', sans-serif;
      font-size: 0.9rem;
      transition: 0.2s;
      /* (‡∏•‡∏ö display: block, margin-left: auto, margin-top: 10px) */
      width: fit-content; 
    }
    .btn-cancel-order:hover { background: #d93025; }
    .btn-cancel-order:disabled { background: #ccc; cursor: not-allowed; }
    
    .btn-edit-order { /* üëà [‡πÉ‡∏´‡∏°‡πà] */
      background: #f0ad4e;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-family: 'Mitr', sans-serif;
      font-size: 0.9rem;
      transition: 0.2s;
    }
    .btn-edit-order:hover { background: #df9e3c; }
    .btn-edit-order:disabled { background: #ccc; }
    /* ‚≠êÔ∏è‚≠êÔ∏è [END] CSS ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‚≠êÔ∏è‚≠êÔ∏è */
    
    .chat-btn { position: fixed; bottom: 80px; right: 20px; background: var(--primary); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: grab; z-index: 1000; font-size: 24px; }
    .chat-window { display: none; position: fixed; bottom: 150px; right: 20px; width: 300px; height: 400px; background: white; box-shadow: 0 5px 15px rgba(0,0,0,0.2); border-radius: 10px; flex-direction: column; z-index: 1000; overflow: hidden; font-family: 'Mitr'; }
    .chat-header { background: var(--primary); color: white; padding: 10px; display: flex; justify-content: space-between; align-items: center; cursor: grab; }
    .chat-body { flex: 1; padding: 10px; overflow-y: auto; background: #f9f9f9; display: flex; flex-direction: column; gap: 10px; }
    .chat-input-area { padding: 10px; border-top: 1px solid #ddd; display: flex; }
    .chat-input-area input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 20px; outline: none; font-family: 'Mitr'; }
    .chat-input-area button { background: var(--primary); color: white; border: none; padding: 8px 15px; margin-left: 5px; border-radius: 20px; cursor: pointer; font-family: 'Mitr'; }
    .msg { padding: 8px 12px; border-radius: 15px; max-width: 80%; font-size: 1rem; }
    .msg-user { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
    .msg-admin { background: #e0e0e0; color: #333; align-self: flex-start; border-bottom-left-radius: 2px; }
    #toast { visibility: hidden; min-width: 200px; background-color: rgba(0, 0, 0, 0.8); color: #fff; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 2000; left: 50%; top: 50%; transform: translate(-50%, -50%); font-size: 1rem; opacity: 0; transition: opacity 0.3s, visibility 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; }
    #toast.show { visibility: visible; opacity: 1; }
    #toast.error { background-color: rgba(220, 53, 69, 0.9); }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color:#555; }
    .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; font-family: 'Mitr', sans-serif; font-size: 1rem; }
    .payment-options label { display: block; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 5px; cursor: pointer; display:flex; align-items:center; gap:10px; }
    .payment-options input:checked + span { color: var(--primary); font-weight: 600; }
    #bankDetails { display: none; background: #f9f9f9; padding: 15px; border-radius: 5px; border: 1px solid #eee; margin-top: 10px; animation: fadeIn 0.3s; }
    .bank-select { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #ddd; font-family: 'Mitr'; }
    #qrCodeContainer { text-align: center; margin-top: 10px; display: none; }
    #qrCodeContainer img { width: 200px; border: 1px solid #ddd; border-radius: 10px; }
    .bank-info { font-size: 1rem; color: #555; text-align: center; margin-top: 5px; }
    .qty-selector { display: flex; align-items: center; justify-content: center; margin: 20px 0; }
    .qty-btn { width: 40px; height: 40px; border: 1px solid #ddd; background: white; font-size: 1.2rem; cursor: pointer; color: #555; border-radius: 5px; display: flex; align-items: center; justify-content: center; }
    .qty-display { width: 60px; text-align: center; font-size: 1.2rem; font-weight: 600; border: none; font-family: 'Mitr'; }
    .modal-product-img { width: 100px; height: 100px; object-fit: cover; border-radius: 5px; margin-right: 15px; }
    .modal-product-info { display: flex; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
    .fav-item-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .empty-fav { grid-column: span 2; text-align: center; color: #999; padding: 20px; }
    .profile-header-edit { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; }
    
    /* ‚≠êÔ∏è‚≠êÔ∏è [START] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç CSS ‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå ‚≠êÔ∏è‚≠êÔ∏è */
    .profile-img-large { 
      width: 130px; /* üëà ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏à‡∏≤‡∏Å 100px */
      height: 130px; /* üëà ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏à‡∏≤‡∏Å 100px */
      border-radius: 50%; 
      object-fit: cover; 
      border: 3px solid #eee; 
      margin-bottom: 15px; /* üëà ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å 10px */
    }
    /* ‚≠êÔ∏è‚≠êÔ∏è [END] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç CSS ‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå ‚≠êÔ∏è‚≠êÔ∏è */
    
    .upload-label { cursor: pointer; color: var(--primary); font-size: 0.9rem; display: flex; align-items: center; gap: 5px; background: #F3F0FF; padding: 5px 15px; border-radius: 20px; transition: 0.2s; }
    .upload-label:hover { background: #E9E4FF; }
    .logout-btn { width: 100%; background: #eee; color: #333; margin-top: 10px; font-family: 'Mitr'; font-weight:600; }
    .size-selector { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
    .size-btn { padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; background: white; font-family: 'Mitr'; }
    .size-btn.active { border-color: var(--primary); background: #F3F0FF; color: var(--primary); font-weight: 600; }
    
    /* (1) CSS: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà '‡∏´‡∏°‡∏î' */
    .size-btn:disabled { 
      background: #f9f9f9; color: #ccc; cursor: not-allowed; 
      text-decoration: line-through; /* ‡∏Ç‡∏µ‡∏î‡∏Ü‡πà‡∏≤ */
    }

    /* --- (CSS ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å) --- */
    .msg-options {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 10px;
    }
    /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏î‡∏π‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÅ‡∏™‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ */
    .msg-admin .msg-options {
      border-top: 1px solid rgba(255,255,255,0.2);
      padding-top: 10px;
    }
    .option-btn {
      background: #F3F0FF;
      color: var(--primary);
      border: 1px solid var(--primary);
      padding: 8px 12px;
      border-radius: 20px;
      cursor: pointer;
      font-family: 'Mitr', sans-serif;
      font-weight: 500;
      text-align: center;
      transition: 0.2s;
    }
    .option-btn:hover {
      background: #E9E4FF;
      transform: scale(1.02);
    }
    /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤ "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß" */
    .option-btn-selected {
      font-size: 0.9rem;
      opacity: 0.8;
      margin: 0;
      padding-top: 5px;
      text-align: center;
      font-style: italic;
    }

  </style>
</head>
<body>

  <header>
    <div class="search-bar" id="searchBarContainer">
      <i class="fas fa-search" style="color: #666;"></i>
      
      <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." 
             onkeyup="handleSearchKey(event)" 
             onfocus="showHistory()">
             
      <div id="searchHistoryDropdown"></div>
    </div>
    
    <div class="icon-btn" onclick="openFav()" title="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö"><i class="fas fa-heart"></i></div>
    <div class="icon-btn" onclick="openHistory()" title="‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠"><i class="fas fa-history"></i></div>
    <div class="icon-btn" onclick="openCart()" title="‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"><i class="fas fa-shopping-cart"></i><span class="cart-badge" id="cartCount">0</span></div>
    <div id="authContainer">
       <div id="loginBtn" onclick="window.location.href='index.html'" style="margin-left:5px; color:white; font-size:1rem; cursor:pointer; white-space: nowrap; display:none;">
         <i class="fas fa-user-circle"></i> Login
       </div>
       <div id="userProfileBtn" class="profile-menu" onclick="openProfileModal()" style="display:none;">
         <img src="https://via.placeholder.com/50" class="header-avatar" id="headerAvatar">
         <span class="header-name" id="headerName">User</span>
       </div>
    </div>
  </header>

  <div class="category-bar" id="categoryBar">
    <div class="cat-item active" onclick="filterCategory('‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', this)">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
    <div class="cat-item" onclick="filterCategory('‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤‡πÅ‡∏ü‡∏ä‡∏±‡πà‡∏ô', this)">‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤ ‡∏ú‡∏ä./‡∏ú‡∏ç.</div>
    <div class="cat-item" onclick="filterCategory('‡∏Å‡∏≤‡∏á‡πÄ‡∏Å‡∏á', this)">‡∏Å‡∏≤‡∏á‡πÄ‡∏Å‡∏á ‡∏ú‡∏ä./‡∏ú‡∏ç.</div>
    <div class="cat-item" onclick="filterCategory('‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏Æ‡∏π‡πâ‡∏î', this)">‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏Æ‡∏π‡πâ‡∏î</div>
    <div class="cat-item" onclick="filterCategory('‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏î‡∏±‡∏ö', this)">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏î‡∏±‡∏ö</div>
    <div class="cat-item" onclick="filterCategory('‡∏´‡∏°‡∏ß‡∏Å', this)">‡∏´‡∏°‡∏ß‡∏Å</div>
    <div class="cat-item" onclick="filterCategory('‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤', this)">‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤</div>
  </div>

  <div id="toast"><i class="fas fa-check-circle"></i> <span>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</span></div>
  <div class="product-container" id="productList"><p style="width:100%; text-align:center;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...</p></div>

  <div id="profileModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('profileModal')">&times;</span>
      <h2>üë§ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</h2>
      
      <div class="profile-header-edit" style="gap: 10px;">
        <img src="https://via.placeholder.com/130" class="profile-img-large" id="editAvatarPreview"> 
        
        <label for="uploadPhotoInput" class="upload-label">
          <i class="fas fa-camera"></i> ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
        </label>

        <input type="file" id="uploadPhotoInput" accept="image/*" style="display:none;" onchange="previewImage(event)">
      </div>
      <div class="form-group">
        <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
        <input type="text" id="editEmail" class="form-control" disabled style="background:#f9f9f9; color:#888;">
      </div>
      <div class="form-group">
        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á (‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô)</label>
        <input type="text" id="editName" class="form-control" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...">
      </div>
      <button id="saveProfileBtn" class="checkout-btn" onclick="saveProfile()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</button>
      
      <button id="getCouponBtn" class="checkout-btn" onclick="getLoginCoupon()" style="background-color: #28a745; margin-top: 10px;">
          <i class="fas fa-ticket-alt"></i> ‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
      </button>
      <button class="checkout-btn logout-btn" onclick="closeModal('profileModal'); openLogoutConfirm()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
  </div>

  <div id="qtyModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
      <span class="close-btn" onclick="closeModal('qtyModal')">&times;</span>
      <h3 style="margin-top:0;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ã‡∏™‡πå‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</h3>
      <div class="modal-product-info">
        <img id="qtyImg" class="modal-product-img" src="">
        <div>
          <div id="qtyName" style="font-weight:bold; margin-bottom:5px;"></div>
          <div id="qtyPrice" style="color:var(--primary);"></div>
          <div id="qtyTotalStock" style="font-size:0.9rem; color:#888;"></div>
        </div>
      </div>
      
      <label style="font-weight: 600; margin-bottom: 10px; display: block; color: #555;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ã‡∏™‡πå:</label>
      <div id="sizeSelector" class="size-selector">
        </div>
      
      <label style="font-weight: 600; margin-bottom: 10px; display: block; color: #555;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</label>
      <div class="qty-selector" style="margin-top:0;">
        <button class="qty-btn" onclick="changeQty(-1)"><i class="fas fa-minus"></i></button>
        <input type="text" id="qtyDisplay" class="qty-display" value="1" readonly>
        <button class="qty-btn" onclick="changeQty(1)"><i class="fas fa-plus"></i></button>
      </div>
      
      <button class="checkout-btn" onclick="submitToCart()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</button>
    </div>
  </div>

  <div id="cartModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('cartModal')">&times;</span>
      <h2>üõí ‡∏ï‡∏£‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
      <div id="cartItemsContainer"><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏£‡∏∞‡∏Å‡∏£‡πâ‡∏≤</p></div>
      <div class="coupon-box" style="margin-top: 15px; display:flex; gap:10px;">
        <input type="text" id="couponInput" class="form-control" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î" style="margin:0; font-family:'Mitr';">
        <button id="couponBtn" onclick="applyCoupon()" style="width:auto; padding: 0 20px; font-size: 1rem; margin:0; font-family:'Mitr';">‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î</button>
      </div>
      <div style="margin-top: 20px; border-top: 2px dashed #ddd; padding-top:10px; font-size:1rem; display:flex; flex-direction:column; gap: 5px;">
        <div style="display:flex; justify-content:space-between;">
          <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (Subtotal)</span>
          <span id="subTotalPrice">‡∏ø0</span>
        </div>
        <div id="discountDisplay" style="display:flex; justify-content:space-between; color:green; display:none;">
          <span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (<span id="couponCodeDisplay"></span>)</span>
          <span id="discountAmount"></span>
        </div>
        <div style="display:flex; justify-content:space-between; font-size:1.2rem; font-weight:600; margin-top:5px;">
          <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
          <span id="totalPrice" style="color:var(--primary)">‡∏ø0</span>
        </div>
      </div>
      <button class="checkout-btn" onclick="openPayment()">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
    </div>
  </div>
  
  <div id="paymentModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('paymentModal')">&times;</span>
      <h2>üì¶ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h2>
      <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px dashed #ddd;">
        <h3 style="font-size:1.1rem; color:var(--primary);">1. ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</h3> <div class="form-group"><input type="text" id="custName" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö"></div>
        <div class="form-group"><input type="tel" id="custPhone" class="form-control" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå"></div>
        <div class="form-group"><textarea id="custAddress" class="form-control" rows="3" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á..."></textarea></div>
      </div>
      <div>
        <h3 style="font-size:1.1rem; color:var(--primary);">2. ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3> <div class="payment-options">
          <label onclick="toggleBank(false)"><input type="radio" name="payment" value="cod" checked> <span><i class="fas fa-truck"></i> ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á (COD)</span></label>
          <label onclick="toggleBank(true)"><input type="radio" name="payment" value="bank"> <span><i class="fas fa-university"></i> ‡πÇ‡∏≠‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ / QR</span></label>
          <div id="bankDetails">
             <p style="font-size:0.95rem; margin-bottom:5px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£:</p>
             <select id="bankSelect" class="bank-select" onchange="showQR()">
               <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
               <option value="kbank">‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢ (KBANK)</option>
               <option value="scb">‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå (SCB)</option>
               <option value="promptpay">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå</option>
             </select>
             <div id="qrCodeContainer">
               <img id="qrImage" src="" alt="QR Code">
               <div class="bank-info" id="bankInfoText"></div>
               <div style="color:red; font-size:0.9rem; margin-top:5px;">*‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó‡∏´‡∏•‡∏±‡∏á‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</div>
             </div>
          </div>
        </div>
      </div>
      <button class="checkout-btn" id="confirmPayBtn" onclick="confirmOrder()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
    </div>
  </div>

  <div id="historyModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('historyModal')">&times;</span>
      <h2>üïí ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h2>
      <div id="historyContainer" style="margin-top:20px;"><p style="text-align:center;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p></div>
    </div>
  </div>

  <div id="favModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('favModal')">&times;</span>
      <h2>‚ù§Ô∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö</h2>
      <div id="favContainer" class="fav-item-grid" style="margin-top:20px;"></div>
    </div>
  </div>

  <div id="confirmModal" class="modal" style="align-items: center;">
    <div class="confirm-modal-box">
      <div id="confirmIcon" class="confirm-icon">‚ùì</div>
      <div id="confirmTitle" class="confirm-title">‡∏¢‡∏∑‡∏ôS‡∏¢‡∏±‡∏ô?</div>
      <div id="confirmDesc" class="confirm-desc">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...</div>
      <div class="confirm-actions">
        <button class="btn-confirm-action btn-no" onclick="closeModal('confirmModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="btn-confirm-action btn-yes" id="btnConfirmAction">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
      </div>
    </div>
  </div>

  <div id="successModal" class="modal" style="align-items: center;">
    <div class="confirm-modal-box">
      <div class="confirm-icon" style="color:#4CAF50;"><i class="fas fa-check-circle"></i></div>
      <div class="confirm-title">‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div>
      <div class="confirm-desc">‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ‡∏ó‡∏≤‡∏á‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</div>
      <div class="confirm-actions">
        <button class="btn-confirm-action btn-ok" onclick="closeModal('successModal')">‡∏ï‡∏Å‡∏•‡∏á</button>
      </div>
    </div>
  </div>

  <div id="editAddressModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('editAddressModal')">&times;</span>
      <h2>‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</h2>
      <p style="font-size:0.9rem; color:#888; margin-top:-10px; margin-bottom:20px;">‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á "‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏™‡πà‡∏á"</p>
      <div class="form-group">
        <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö</label>
        <input type="text" id="editCustName" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö">
      </div>
      <div class="form-group">
        <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
        <input type="tel" id="editCustPhone" class="form-control" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå">
      </div>
      <div class="form-group">
        <label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</label>
        <textarea id="editCustAddress" class="form-control" rows="3" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á..."></textarea>
      </div>
      <button id="saveAddressBtn" class="checkout-btn" onclick="saveAddress()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</button>
    </div>
  </div>
  <div class="chat-btn" id="chatBtn"><i class="fas fa-comments"></i></div>
  <div class="chat-window" id="chatWindow">
    <div class="chat-header"><span>üí¨ ‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</span><span style="cursor:pointer" onclick="toggleChat()">&times;</span></div>
    <div class="chat-body" id="chatBody"><div class="msg msg-admin">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö?</div></div>
    <div class="chat-input-area">
      <input type="text" id="msgInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." onkeypress="handleEnter(event)">
      <button onclick="sendMsg()">‡∏™‡πà‡∏á</button>
    </div>
  </div>
  
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script> <script>
    // --- (Firebase Config ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
    const firebaseConfig = {
      apiKey: "AIzaSyA7lELq82KxJ0sFDf6jKmWPDFKpKqHJp0c",
      authDomain: "king007-c72e2.firebaseapp.com",
      projectId: "king007-c72e2",
      storageBucket: "king007-c72e2.firebasestorage.app",
      messagingSenderId: "136587774092",
      appId: "1:136587774092:web:4ee67ff03cdee67bb393a9",
      measurementId: "G-K39CYF7766"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage(); // üëà (‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÑ‡∏ß‡πâ ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏ä‡πâ)

    // --- ‚õî ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ‚õî ---
    document.addEventListener('contextmenu', (e) => { e.preventDefault(); });
    document.addEventListener('copy', (e) => {
      e.preventDefault();
      showToast('‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤', true); 
    });
    // --- ‚õî --------------------------- ‚õî ---

    // (3) JS: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡πÑ‡∏ã‡∏™‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    let allProducts=[], cart=[], userFavorites=[];
    
    // (1) ‚≠êÔ∏è [‡πÉ‡∏´‡∏°‡πà] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    let searchHistory = [];
    const MAX_HISTORY = 7; // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏ß‡πâ 7 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    const HISTORY_KEY = 'shop_searchHistory'; // ‡∏ä‡∏∑‡πà‡∏≠ key ‡πÉ‡∏ô localStorage
    
    let currentSelectedId=null, currentQty=1, currentSelectedSize=null;
    let currentSelectedSizeStock = null; // üëà ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ô‡∏µ‡πâ
    
    // ‚≠êÔ∏è‚≠êÔ∏è [START] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ ‚≠êÔ∏è‚≠êÔ∏è
    let currentAvatarFile = null; // üëà [3] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö "‡πÑ‡∏ü‡∏•‡πå"
    // ‚≠êÔ∏è‚≠êÔ∏è [END] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ ‚≠êÔ∏è‚≠êÔ∏è
    
    // (‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    let subtotalAmount = 0;
    let discountApplied = 0;
    let finalTotalAmount = 0;
    let currentDiscount = { code: null, type: null, value: 0 };
    
    // ‚≠êÔ∏è‚≠êÔ∏è [‡πÉ‡∏´‡∏°‡πà] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö ID ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‚≠êÔ∏è‚≠êÔ∏è
    let currentEditingOrderId = null; 
    
    let userId = localStorage.getItem('shop_userId');
    if (!userId) { userId = 'guest_' + Math.random().toString(36).substr(2, 9); localStorage.setItem('shop_userId', userId); }
    
    // üî• [NEW] ‡∏¢‡πâ‡∏≤‡∏¢ currentUserData ‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô Global
    let currentUserData = {};

    // üî• --- [START] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Timer 30 ‡∏ô‡∏≤‡∏ó‡∏µ --- üî•
    let inactivityTimer = null; 
    // 30 ‡∏ô‡∏≤‡∏ó‡∏µ = 30 * 60 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ * 1000 ‡∏°‡∏¥‡∏•‡∏•‡∏¥‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ = 1,800,000
    const INACTIVITY_TIMEOUT_MS = 1800000; 
    // (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö: 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ = 10000)
    // const INACTIVITY_TIMEOUT_MS = 10000; 
    // üî• --- [END] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ --- üî•


    // ‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è [START] ‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ (‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î + ‡πÅ‡∏õ‡∏•‡∏á Base64) ‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è
    
    /**
     * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡πà‡∏≠/‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
     * @param {File} file - ‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö
     * @param {number} maxWidth - ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
     * @param {number} maxHeight - ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
     * @param {number} quality - ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û (0.0 - 1.0)
     * @returns {Promise<Blob>} - Promise ‡∏ó‡∏µ‡πà‡∏à‡∏∞ resolve ‡πÄ‡∏õ‡πá‡∏ô Blob ‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß
     */
    function resizeImage(file, maxWidth, maxHeight, quality) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            let width = img.width;
            let height = img.height;

            // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà (‡∏Ñ‡∏á‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô)
            if (width > height) {
              if (width > maxWidth) {
                height = Math.round(height * (maxWidth / width));
                width = maxWidth;
              }
            } else {
              if (height > maxHeight) {
                width = Math.round(width * (maxHeight / height));
                height = maxHeight;
              }
            }
            
            // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á Canvas
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            
            // 3. ‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ‡∏•‡∏á‡∏ö‡∏ô Canvas
            ctx.drawImage(img, 0, 0, width, height);
            
            // 4. ‡πÅ‡∏õ‡∏•‡∏á Canvas ‡πÄ‡∏õ‡πá‡∏ô Blob (‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà)
            canvas.toBlob((blob) => {
              if (blob) {
                resolve(blob);
              } else {
                reject(new Error('Canvas to Blob conversion failed.'));
              }
            }, 'image/jpeg', quality); // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô JPEG ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î
          };
          img.onerror = reject;
          img.src = e.target.result; // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÄ‡∏Ç‡πâ‡∏≤ <image>
        };
        reader.onerror = reject;
        reader.readAsDataURL(file); // ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå
      });
    }

    function blobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }
    // ‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è [END] ‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡∏°‡πà ‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è
    

    window.onload = async () => {
    
      // (2) ‚≠êÔ∏è [‡πÉ‡∏´‡∏°‡πà] ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏´‡∏•‡∏î
      loadSearchHistory(); 
      
      // (3) ‚≠êÔ∏è [‡πÉ‡∏´‡∏°‡πà] ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡πà‡∏≠‡∏ô dropdown ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏∑‡πà‡∏ô
      document.addEventListener('click', (e) => {
        const container = document.getElementById('searchBarContainer');
        if (container && !container.contains(e.target)) {
          hideHistory();
        }
      });
      
      auth.onAuthStateChanged(async user => {
        if (user) {
          userId = user.uid;
          document.getElementById('loginBtn').style.display = 'none';
          document.getElementById('userProfileBtn').style.display = 'flex';
          listenToChat();
          listenToChatStatus(); // üî• [NEW] ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏±‡∏Å‡∏ü‡∏±‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ö‡∏•‡πá‡∏≠‡∏Ñ
          loadFavorites();
          await loadUserProfile(user); 
        } else {
          // üî• [NEW] ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ login ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ currentUserData ‡πÄ‡∏õ‡πá‡∏ô Guest
          currentUserData = {
            displayName: 'Guest',
            photoURL: null,
            email: 'guest@example.com'
          };
          document.getElementById('loginBtn').style.display = 'block';
          document.getElementById('userProfileBtn').style.display = 'none';
          listenToChat();
          listenToChatStatus(); // üî• [NEW] ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏±‡∏Å‡∏ü‡∏±‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ö‡∏•‡πá‡∏≠‡∏Ñ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Guest)
        }
      });
      await checkAndSeedData(); // üëà (4) JS: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ
      loadProductsFromDB();
      
      // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏≤‡∏Å‡πÅ‡∏ä‡∏ó (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
      const chatWindow = document.getElementById('chatWindow');
      const chatHeader = chatWindow.querySelector('.chat-header');
      const chatButton = document.getElementById('chatBtn');
      makeDraggable(chatWindow, chatHeader, null);
      makeDraggable(chatButton, chatButton, toggleChat);
    function makeDraggable(element, handle, onClickCallback) {
      let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
      let dragged = false; 
      handle.onmousedown = dragStart;
      handle.ontouchstart = dragStart;
      function dragStart(e) {
        e = e || window.event;
        dragged = false; 
        if (e.type === 'touchstart') {
          pos3 = e.touches[0].clientX;
          pos4 = e.touches[0].clientY;
        } else {
          e.preventDefault(); 
          pos3 = e.clientX;
          pos4 = e.clientY;
        }
        if (element.style.top === "" || element.style.left === "") {
          const rect = element.getBoundingClientRect();
          element.style.top = rect.top + 'px';
          element.style.left = rect.left + 'px';
          element.style.bottom = 'auto'; element.style.right = 'auto';
        }
        document.onmouseup = dragEnd;
        document.ontouchend = dragEnd;
        document.onmousemove = elementDrag;
        document.ontouchmove = elementDrag;
        handle.style.cursor = 'grabbing'; 
      }
      function elementDrag(e) {
        e = e || window.event;
        e.preventDefault(); 
        let clientX, clientY;
        if (e.type === 'touchmove') {
          clientX = e.touches[0].clientX;
          clientY = e.touches[0].clientY;
        } else {
          clientX = e.clientX;
          clientY = e.clientY;
        }
        dragged = true; 
        pos1 = pos3 - clientX;
        pos2 = pos4 - clientY;
        pos3 = clientX;
        pos4 = clientY;
        let newTop = element.offsetTop - pos2;
        let newLeft = element.offsetLeft - pos1;
        if (newTop < 0) newTop = 0;
        if (newLeft < 0) newLeft = 0;
        if (newTop + element.clientHeight > window.innerHeight) newTop = window.innerHeight - element.clientHeight;
        if (newLeft + element.clientWidth > window.innerWidth) newLeft = window.innerWidth - element.clientWidth;
        element.style.top = newTop + "px";
        element.style.left = newLeft + "px";
      }
      function dragEnd() {
        document.onmouseup = null; 
        document.ontouchend = null;
        document.onmousemove = null; 
        document.ontouchmove = null;
        handle.style.cursor = 'grab'; 
        if (!dragged && onClickCallback) { 
          onClickCallback(); 
        }
      }
    }
    // --- (‡∏à‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏≤‡∏Å) ---
    };
    
    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
    // (‡∏¢‡πâ‡∏≤‡∏¢ let currentUserData = {}; ‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô Global)
    
    // ‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è [START] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô loadUserProfile (‡∏Å‡∏±‡∏ô undefined) ‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è
    async function loadUserProfile(user) {
      
      // (1) ‚≠êÔ∏è [FIX] ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏à‡∏≤‡∏Å Auth object (user) ‡∏Å‡πà‡∏≠‡∏ô
      // ‡∏ô‡∏µ‡πà‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤ email ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö Login ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
      currentUserData = {
        email: user.email, 
        displayName: user.displayName || (user.email ? user.email.split('@')[0] : 'New User'),
        photoURL: user.photoURL || 'https://via.placeholder.com/150?text=User',
        hasClaimedMemberCoupon: false // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
      };

      // (2) ‚≠êÔ∏è [FIX] ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÉ‡∏ô Firestore
      const doc = await db.collection('users').doc(user.uid).get();
      
      if (doc.exists) { 
          // (3) ‚≠êÔ∏è [FIX] ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÉ‡∏´‡πâ‡∏ô‡∏≥‡∏°‡∏≤ "‡∏ó‡∏±‡∏ö" ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
          // (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‡πÄ‡∏ä‡πà‡∏ô displayName, photoURL)
          const firestoreData = doc.data();
          currentUserData.displayName = firestoreData.displayName || currentUserData.displayName;
          currentUserData.photoURL = firestoreData.photoURL || currentUserData.photoURL;
          currentUserData.hasClaimedMemberCoupon = firestoreData.hasClaimedMemberCoupon || false;
      } 
      
      // (4) ‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ 'else' ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß
      
      updateProfileUI();
    }
    // ‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è [END] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô loadUserProfile ‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è
    
    function updateProfileUI() {
      document.getElementById('headerName').innerText = currentUserData.displayName;
      document.getElementById('headerAvatar').src = currentUserData.photoURL;
      document.getElementById('editName').value = currentUserData.displayName;
      document.getElementById('editEmail').value = currentUserData.email;
      document.getElementById('editAvatarPreview').src = currentUserData.photoURL;
      document.getElementById('custName').value = currentUserData.displayName;
    }
    
    // ‚≠êÔ∏è [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] 3. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Modal Profile ‚≠êÔ∏è
    function openProfileModal() { 
      currentAvatarFile = null; // üëà ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      
      // ‚≠êÔ∏è [‡πÉ‡∏´‡∏°‡πà] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á ‚≠êÔ∏è
      const couponBtn = document.getElementById('getCouponBtn');
      if (currentUserData.hasClaimedMemberCoupon === true) {
          couponBtn.disabled = true;
          couponBtn.innerHTML = '<i class="fas fa-check"></i> ‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡πÅ‡∏•‡πâ‡∏ß (SALE100)';
          couponBtn.style.background = '#6c757d'; // ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤
      } else {
          couponBtn.disabled = false;
          couponBtn.innerHTML = '<i class="fas fa-ticket-alt"></i> ‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å';
          couponBtn.style.background = '#28a745'; // ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
      }
      // ‚≠êÔ∏è [‡∏à‡∏ö] ‚≠êÔ∏è
      
      document.getElementById('profileModal').style.display = 'flex'; 
    }
    

    // ‚≠êÔ∏è‚≠êÔ∏è [START] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô previewImage (‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏£‡∏π‡∏õ) ‚≠êÔ∏è‚≠êÔ∏è
    async function previewImage(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const preview = document.getElementById('editAvatarPreview');

      // (1) ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏ç‡πà)
      preview.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='40' stroke='%23ddd' stroke-width='10' fill='none'/%3E%3Ccircle cx='50' cy='50' r='40' stroke='%237A56D3' stroke-width='10' fill='none' stroke-dasharray='250' stroke-dashoffset='0'%3E%3Canimate attributeName='stroke-dashoffset' from='0' to='502' dur='2s' repeatCount='indefinite'/%3E%3C/circle%3E%3C/svg%3E";

      try {
        // --- ‚öôÔ∏è (‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ) ‚öôÔ∏è ---
        const MAX_WIDTH = 800;  // üëà ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 800px
        const MAX_HEIGHT = 800; // üëà ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 800px
        const QUALITY = 0.7;    // üëà ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û 70%
        // ------------------------------------

        // (2) ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏£‡∏π‡∏õ
        const resizedBlob = await resizeImage(file, MAX_WIDTH, MAX_HEIGHT, QUALITY);

        // (3) ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å!)
        // ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô .jpg ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô jpeg
        const originalName = file.name.split('.').slice(0, -1).join('.');
        resizedBlob.name = `${originalName}_${Date.now()}.jpg`;

        // (4) ‡πÄ‡∏Å‡πá‡∏ö "‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß" ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£
        currentAvatarFile = resizedBlob; 
        
        // (5) ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (‡∏à‡∏≤‡∏Å Blob ‡∏ó‡∏µ‡πà‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß)
        preview.src = URL.createObjectURL(resizedBlob);

      } catch (err) {
        console.error("Error resizing image:", err);
        showToast("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏î‡πâ", true);
        preview.src = currentUserData.photoURL; // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏¥‡∏°
        currentAvatarFile = null;
      }
    }
    // ‚≠êÔ∏è‚≠êÔ∏è [END] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô previewImage ‚≠êÔ∏è‚≠êÔ∏è
    

    // ‚≠êÔ∏è‚≠êÔ∏è [START] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô saveProfile (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ Storage) ‚≠êÔ∏è‚≠êÔ∏è
    async function saveProfile() {
      const btn = document.getElementById('saveProfileBtn');
      btn.disabled = true;
      
      const newName = document.getElementById('editName').value.trim();
      
      // üëà (1) ‡πÄ‡∏≠‡∏≤ URL/Base64 ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏à‡∏≤‡∏Å "‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á" ‡∏°‡∏≤
      let newImgSrc = document.getElementById('editAvatarPreview').src; 
      
      if(!newName) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠', true);
        btn.disabled = false;
        return;
      }

      try {
        // (2) ‚≠êÔ∏è [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà" (‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô Blob) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (currentAvatarFile) {
          btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏π‡∏õ...";
          
          // (3) ‚≠êÔ∏è [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÅ‡∏õ‡∏•‡∏á Blob (‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß) ‡πÄ‡∏õ‡πá‡∏ô Base64
          newImgSrc = await blobToBase64(currentAvatarFile);
          
          currentAvatarFile = null; // üëà ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÅ‡∏õ‡∏•‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        }

        // (4) ‚≠êÔ∏è [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Firestore (‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ newImgSrc ‡∏Ñ‡∏∑‡∏≠ Base64)
        btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
        
        const dataToSave = {
          ...currentUserData, 
          displayName: newName,
          photoURL: newImgSrc, // üëà ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Base64 string ‡∏•‡∏á‡πÑ‡∏õ
          email: currentUserData.email
        };
        
        await db.collection('users').doc(userId).set(dataToSave, { merge: true });

        // (5) ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
        currentUserData.displayName = newName;
        currentUserData.photoURL = newImgSrc;
        updateProfileUI();
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        closeModal('profileModal');
        
      } catch(e) { 
        console.error(e); 
        // ‚≠êÔ∏è [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Error (‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å Base64 ‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô 1MB)
        if (e.message && e.message.includes("exceeds the maximum size")) {
            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ!', true);
        } else {
            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.message, true);
        }
      } finally { 
        btn.disabled = false;
        btn.innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á";
      }
    }
    // ‚≠êÔ∏è‚≠êÔ∏è [END] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô saveProfile ‚≠êÔ∏è‚≠êÔ∏è
    
    
    async function getLoginCoupon() {
        // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ã‡πâ‡∏≥
        if (userId.startsWith('guest_') || currentUserData.hasClaimedMemberCoupon === true) {
            return;
        }

        const btn = document.getElementById('getCouponBtn');
        btn.disabled = true;
        btn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...';

        try {
            // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï "flag" ‡πÉ‡∏ô Firestore
            await db.collection('users').doc(userId).set({
                hasClaimedMemberCoupon: true
            }, { merge: true });

            // 3. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• local
            currentUserData.hasClaimedMemberCoupon = true;

            // 4. ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (‡πÉ‡∏ä‡πâ Modal ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à)
            closeModal('profileModal'); // ‡∏õ‡∏¥‡∏î modal ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
            
            // ‚≠êÔ∏è [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÉ‡∏ä‡πâ successModal ‚≠êÔ∏è
            document.querySelector('#successModal .confirm-title').innerText = '‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!';
            document.querySelector('#successModal .confirm-desc').innerText = '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î: MEMBER50(‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î 50 ‡∏ö‡∏≤‡∏ó),SALE100(‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î 25%)  ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
            document.getElementById('successModal').style.display = 'flex';
            
            // (‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ modal ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô "‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à" ‡∏î‡πâ‡∏ß‡∏¢ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏±‡∏ô‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î)
            document.getElementById('successModal').querySelector('.btn-ok').onclick = () => {
                closeModal('successModal');
                // (‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°)
                document.querySelector('#successModal .confirm-title').innerText = '‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!';
                document.querySelector('#successModal .confirm-desc').innerText = '‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ‡∏ó‡∏≤‡∏á‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î';
            };

        } catch (err) {
            console.error("Error claiming coupon:", err);
            showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message, true);
            btn.disabled = false; // ‡∏Ñ‡∏∑‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏Å‡∏î‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ
            btn.innerText = '‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å';
        }
    }
    // üî• --- [START] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô openLogoutConfirm --- üî•
    function openLogoutConfirm() {
      document.getElementById('confirmIcon').innerHTML = 'üö™';
      document.getElementById('confirmTitle').innerText = '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?';
      document.getElementById('confirmDesc').innerText = '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà';
      const btnConfirm = document.getElementById('btnConfirmAction');
      btnConfirm.innerText = '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö';
      
      // (1) ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô async function
      btnConfirm.onclick = async () => {
        try {
          // (2) ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà login ‡∏≠‡∏¢‡∏π‡πà (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà guest)
          // ID ‡∏Ç‡∏≠‡∏á Guest ‡∏à‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ 'guest_'
          if (userId && !userId.startsWith('guest_')) {
            // (3) ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï field 'welcomeSent' ‡πÄ‡∏õ‡πá‡∏ô false
            // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ login ‡πÉ‡∏´‡∏°‡πà ‡∏ö‡∏≠‡∏ó‡∏à‡∏∞‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
            await db.collection('chats').doc(userId).set({
              welcomeSent: false
            }, { merge: true });
          }
          
          // (4) ‡∏™‡∏±‡πà‡∏á Logout
          await auth.signOut();
          
          // (5) ‡∏•‡∏ö Guest ID (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡πÅ‡∏•‡∏∞ Redirect
          localStorage.removeItem('shop_userId');
          window.location.href = 'index.html';
          
        } catch (err) {
          console.error("Error during logout:", err);
          // ‡∏´‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡πá‡∏¢‡∏±‡∏á‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° log out ‡πÅ‡∏•‡∏∞ redirect
          auth.signOut(); 
          localStorage.removeItem('shop_userId');
          window.location.href = 'index.html';
        }
      };
      document.getElementById('confirmModal').style.display = 'flex';
    }
    // üî• --- [END] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô openLogoutConfirm --- üî•


    // --- (4) JS: ‚≠êÔ∏è‚≠êÔ∏è [START] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (checkAndSeedData) ‚≠êÔ∏è‚≠êÔ∏è ---
    async function checkAndSeedData() {
      const s = await db.collection('products').limit(1).get();
      if(s.empty) {
        console.log("‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡πà‡∏≤‡∏á ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡∏≤‡∏°‡πÑ‡∏ã‡∏™‡πå)...");
        const b = db.batch();
        
        const categories = [
          '‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤‡πÅ‡∏ü‡∏ä‡∏±‡πà‡∏ô', '‡∏Å‡∏≤‡∏á‡πÄ‡∏Å‡∏á', '‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏Æ‡∏π‡πâ‡∏î', 
          '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏î‡∏±‡∏ö', '‡∏´‡∏°‡∏ß‡∏Å', '‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤'
        ]; 
        
        // (4.1) JS: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô helper ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å
        function generateStock(sizes) {
          let sizeStock = {};
          let totalStock = 0;
          
          // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏∏‡πà‡∏° (5-20 ‡∏ä‡∏¥‡πâ‡∏ô) ‡πÉ‡∏´‡πâ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÑ‡∏ã‡∏™‡πå
          sizes.forEach(size => {
            const s = Math.floor(Math.random() * 16) + 5; // ‡∏™‡∏∏‡πà‡∏° 5-20
            sizeStock[size] = s;
            totalStock += s;
          });
          
          // ‡∏™‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ 1 ‡πÑ‡∏ã‡∏™‡πå‡∏´‡∏°‡∏î (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö)
          if (sizes.length > 1) {
            const zeroIndex = Math.floor(Math.random() * sizes.length);
            const sizeToZero = sizes[zeroIndex];
            totalStock -= sizeStock[sizeToZero]; // ‡∏•‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏ö‡∏ß‡∏Å‡πÑ‡∏õ
            sizeStock[sizeToZero] = 0; // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô 0
          }
          
          return { sizeStock, totalStock };
        }

        for (const c of categories) {
          let keyword = 'item'; 
          let sizes = ['One Size']; // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
          let count = 20;

          if (c === '‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤‡πÅ‡∏ü‡∏ä‡∏±‡πà‡∏ô') {
            keyword = 'shirt';
            sizes = ['S (‡∏≠‡∏Å 36")', 'M (‡∏≠‡∏Å 40")', 'L (‡∏≠‡∏Å 44")', 'XL (‡∏≠‡∏Å 48")'];
          } else if (c === '‡∏Å‡∏≤‡∏á‡πÄ‡∏Å‡∏á') {
            keyword = 'jeans';
            sizes = ['28', '30', '32', '34', '36'];
          } else if (c === '‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏Æ‡∏π‡πâ‡∏î') {
            keyword = 'hoodie';
            sizes = ['S (‡∏≠‡∏Å 36")', 'M (‡∏≠‡∏Å 40")', 'L (‡∏≠‡∏Å 44")', 'XL (‡∏≠‡∏Å 48")'];
          } else if (c === '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏î‡∏±‡∏ö') {
            keyword = 'jewelry';
            sizes = ['Free Size'];
          } else if (c === '‡∏´‡∏°‡∏ß‡∏Å') {
            keyword = 'hat';
            sizes = ['Free Size']; 
            count = 10;
          } else if (c === '‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤') {
            keyword = 'shoe';
            sizes = ['39', '40', '41', '42', '43'];
            count = 10;
          }

          // (4.2) JS: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡∏¥‡πâ‡∏ô
          for(let i=1; i<=count; i++) {
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á stock object
            const { sizeStock, totalStock } = generateStock(sizes);

            b.set(db.collection('products').doc(), {
              name: `${c} ${i}`, 
              price: Math.floor(Math.random()*500)+100, 
              // stock: 20, (‡∏•‡∏ö‡∏≠‡∏±‡∏ô‡πÄ‡∏Å‡πà‡∏≤)
              // sizes: sizes, (‡∏•‡∏ö‡∏≠‡∏±‡∏ô‡πÄ‡∏Å‡πà‡∏≤)
              sizeStock: sizeStock,   // üëà (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)
              totalStock: totalStock, // üëà (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)
              category: c, 
              image: `https://source.unsplash.com/300x300/?${keyword}&sig=${i}`, 
              sold: 0
            });
          }
        }
        await b.commit();
        console.log("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (v.‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡∏≤‡∏°‡πÑ‡∏ã‡∏™‡πå) ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
      }
      
      // ‚≠êÔ∏è [‡πÉ‡∏´‡∏°‡πà] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö/‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á MEMBER50 (‡∏ó‡∏≥‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î) ‚≠êÔ∏è
      const couponRef = db.collection('coupons').doc('MEMBER50');
      const couponSnap = await couponRef.get();
      if (!couponSnap.exists) {
          console.log("Creating MEMBER50 coupon...");
          await couponRef.set({
              type: 'fixed',      // ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÅ‡∏ö‡∏ö-
              value: 50,          // 50 ‡∏ö‡∏≤‡∏ó
              quantityAvailable: 1000,  // 1000 ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
              quantityUsed: 0,
              limitPerUser: 1       // 1 ‡∏Ñ‡∏ô/1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
          });
      }
      // ‚≠êÔ∏è [‡∏à‡∏ö] ‚≠êÔ∏è

    }
    // --- (4) JS: ‚≠êÔ∏è‚≠êÔ∏è [END] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‚≠êÔ∏è‚≠êÔ∏è ---
    

    // --- (5) JS: ‚≠êÔ∏è‚≠êÔ∏è [START] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (renderProducts) ‚≠êÔ∏è‚≠êÔ∏è ---
    function loadProductsFromDB() { db.collection('products').onSnapshot(s => { allProducts=[]; s.forEach(d=>allProducts.push({id:d.id,...d.data()})); renderProducts(allProducts); }); }
    
    function renderProducts(p) {
      const c = document.getElementById('productList'); c.innerHTML='';
      if(p.length === 0) {
        c.innerHTML = '<p style="width:100%; text-align:center; color:#999;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p>';
        return;
      }
      p.forEach(x => {
        // (5.1) JS: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏≤‡πÄ‡∏ä‡πá‡∏Å totalStock ‡πÅ‡∏ó‡∏ô stock
        const isOut = x.totalStock <= 0; 
        const stockText = isOut ? '<span style="color:var(--primary);">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î</span>' : `‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${x.totalStock} ‡∏ä‡∏¥‡πâ‡∏ô`; // üëà
        const soldText = `‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß ${x.sold || 0} ‡∏ä‡∏¥‡πâ‡∏ô`;
        const isFav = userFavorites.includes(x.id);

        c.innerHTML += `
          <div class="product-card">
            <button class="fav-btn ${isFav ? 'active' : ''}" onclick="toggleFav('${x.id}')"><i class="${isFav ? 'fas' : 'far'} fa-heart"></i></button>
            <img src="${x.image}" class="p-img">
            <div class="p-details">
              <div><div class="p-name">${x.name}</div><div class="p-stock">${stockText} | ${soldText}</div></div>
              <div><div class="p-price">‡∏ø${x.price}</div>
              <button class="p-btn" onclick="openQtyModal('${x.id}')" ${isOut?'disabled':''}>${isOut?'‡∏´‡∏°‡∏î':'‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤'}</button>
              </div>
            </div>
          </div>`;
      });
    }
    // --- (5) JS: ‚≠êÔ∏è‚≠êÔ∏è [END] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‚≠êÔ∏è‚≠êÔ∏è ---


    // --- (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Favorite ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
    async function loadFavorites() {
       const doc = await db.collection('favorites').doc(userId).get();
       userFavorites = doc.exists ? (doc.data().ids || []) : [];
       renderProducts(allProducts);
    }
    async function toggleFav(id) {
       const idx = userFavorites.indexOf(id);
       if(idx > -1) { userFavorites.splice(idx, 1); showToast('‡∏•‡∏ö‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö'); } 
       else { userFavorites.push(id); showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö'); }
       const btns = document.querySelectorAll(`.fav-btn[onclick="toggleFav('${id}')"]`);
       btns.forEach(btn => {
         if(userFavorites.includes(id)) { btn.classList.add('active'); btn.innerHTML = '<i class="fas fa-heart"></i>'; } 
         else { btn.classList.remove('active'); btn.innerHTML = '<i class="far fa-heart"></i>'; }
       });
       await db.collection('favorites').doc(userId).set({ ids: userFavorites });
    }
    function openFav() {
      document.getElementById('favModal').style.display = 'flex';
      const con = document.getElementById('favContainer');
      con.innerHTML = '';
      const favItems = allProducts.filter(p => userFavorites.includes(p.id));
      if(favItems.length === 0) return con.innerHTML = '<div class="empty-fav">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö</div>';
      favItems.forEach(x => {
        con.innerHTML += `<div class="product-card"><button class="fav-btn active" onclick="toggleFav('${x.id}'); openFav();"><i class="fas fa-heart"></i></button><img src="${x.image}" class="p-img"><div class="p-details"><div class="p-name">${x.name}</div><div class="p-price">‡∏ø${x.price}</div><button class="p-btn" onclick="openQtyModal('${x.id}'); closeModal('favModal');">‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</button></div></div>`;
      });
    }
    function filterCategory(c,el) { document.querySelectorAll('.cat-item').forEach(e=>e.classList.remove('active')); el.classList.add('active'); renderProducts(c==='‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'?allProducts:allProducts.filter(x=>x.category===c)); }
    
    
    // (4) ‚≠êÔ∏è [‡∏•‡∏ö] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô filterProducts() ‡πÄ‡∏î‡∏¥‡∏° (function filterProducts() { const t=... }) ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ
    

    // (5) ‚≠êÔ∏è [‡πÉ‡∏´‡∏°‡πà] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    // --- [‡πÉ‡∏´‡∏°‡πà] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ---
    
    function loadSearchHistory() {
      const storedHistory = localStorage.getItem(HISTORY_KEY);
      if (storedHistory) {
        searchHistory = JSON.parse(storedHistory);
      }
    }

    function showHistory() {
      const dropdown = document.getElementById('searchHistoryDropdown');
      if (!dropdown) return;
      dropdown.innerHTML = '';
      
      if (searchHistory.length === 0) {
        dropdown.innerHTML = '<div class="history-item" style="color:#999; cursor:default;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</div>';
      } else {
        searchHistory.forEach((term, index) => {
          dropdown.innerHTML += `
            <div class="history-item" onclick="useHistory('${term}')">
              <span class="history-text"><i class="fas fa-history" style="color:#aaa; margin-right:8px;"></i> ${term}</span>
              <span class="remove-history-btn" onclick="removeHistoryItem(event, ${index})"><i class="fas fa-times"></i></span>
            </div>
          `;
        });
        dropdown.innerHTML += '<div class="history-clear" onclick="clearHistory()"><i class="fas fa-trash-alt"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>';
      }
      dropdown.style.display = 'block';
    }

    function hideHistory() {
      const dropdown = document.getElementById('searchHistoryDropdown');
      if (dropdown) dropdown.style.display = 'none';
    }

    function useHistory(term) {
      document.getElementById('searchInput').value = term;
      filterProducts(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏•‡∏¢
      hideHistory();
    }

    function removeHistoryItem(event, index) {
      event.stopPropagation(); // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ useHistory() ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
      searchHistory.splice(index, 1);
      localStorage.setItem(HISTORY_KEY, JSON.stringify(searchHistory));
      showHistory(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
    }

    function clearHistory() {
      searchHistory = [];
      localStorage.removeItem(HISTORY_KEY);
      showHistory(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
    }

    function saveSearchTerm(term) {
      if (!term || term.length < 2) return; // ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πâ‡∏ô‡πÜ
      
      // ‡∏•‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡∏≠‡∏≠‡∏Å
      searchHistory = searchHistory.filter(item => item.toLowerCase() !== term.toLowerCase());
      
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô
      searchHistory.unshift(term);
      
      // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
      if (searchHistory.length > MAX_HISTORY) {
        searchHistory = searchHistory.slice(0, MAX_HISTORY);
      }
      
      localStorage.setItem(HISTORY_KEY, JSON.stringify(searchHistory));
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÅ‡∏ó‡∏ô filterProducts() ‡πÄ‡∏î‡∏¥‡∏°
    function handleSearchKey(event) {
      const input = document.getElementById('searchInput');
      const term = input.value.trim();
      
      // (A) ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö Real-time (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
      filterProducts(); 
      
      // (B) ‡∏ñ‡πâ‡∏≤‡∏Å‡∏î Enter ‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
      if (event.key === 'Enter') {
        saveSearchTerm(term);
        input.blur(); // ‡∏ã‡πà‡∏≠‡∏ô‡∏Ñ‡∏µ‡∏¢‡πå‡∏ö‡∏≠‡∏£‡πå‡∏î/‡∏ã‡πà‡∏≠‡∏ô dropdown
        hideHistory();
      }
    }
    
    // (6) ‚≠êÔ∏è [‡πÉ‡∏´‡∏°‡πà] ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô filterProducts() (‡∏ó‡∏µ‡πà‡πÅ‡∏¢‡∏Å‡∏≠‡∏≠‡∏Å‡∏°‡∏≤)
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏≤‡∏¢‡πâ‡∏≤‡∏¢‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
    function filterProducts() { 
      const t = document.getElementById('searchInput').value.toLowerCase(); 
      renderProducts(allProducts.filter(x => x.name.toLowerCase().includes(t))); 
    }
    // --- (‡∏à‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤) ---

    
    // --- (6) JS: ‚≠êÔ∏è‚≠êÔ∏è [START] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Modal (openQtyModal) ‚≠êÔ∏è‚≠êÔ∏è ---
    function openQtyModal(id) {
      const p = allProducts.find(x=>x.id===id);
      if(!p || p.totalStock <= 0) return; // üëà (‡πÄ‡∏ä‡πá‡∏Å totalStock)
      
      currentSelectedId = id; 
      currentQty = 1;
      currentSelectedSize = null; 
      currentSelectedSizeStock = null; // üëà (‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
      
      document.getElementById('qtyImg').src=p.image;
      document.getElementById('qtyName').innerText=p.name;
      document.getElementById('qtyPrice').innerText='‡∏ø'+p.price;
      // üëà (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô totalStock)
      document.getElementById('qtyTotalStock').innerText='‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: '+p.totalStock; 
      document.getElementById('qtyDisplay').value=1;
      
      // (6.1) JS: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ã‡∏™‡πå‡πÉ‡∏´‡∏°‡πà (‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å)
      const sizeContainer = document.getElementById('sizeSelector');
      sizeContainer.innerHTML = ''; 
      
      // üëà (‡πÄ‡∏ä‡πá‡∏Å‡∏à‡∏≤‡∏Å p.sizeStock)
      if (p.sizeStock && Object.keys(p.sizeStock).length > 0) {
        
        const sizeKeys = Object.keys(p.sizeStock);
        let firstAvailableButton = null;

        sizeKeys.forEach(size => {
          const stock = p.sizeStock[size]; // üëà ‡∏î‡∏∂‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡πÑ‡∏ã‡∏™‡πå‡∏ô‡∏µ‡πâ
          
          const btn = document.createElement('button');
          btn.className = 'size-btn';
          // üëà ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ö‡∏ô‡∏õ‡∏∏‡πà‡∏°
          btn.textContent = `${size} (‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${stock})`; 
          
          if (stock <= 0) {
            btn.disabled = true; // üëà ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏´‡∏°‡∏î
          }
          
          btn.onclick = () => { 
            // üëà ‡∏™‡πà‡∏á 'stock' ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡πâ‡∏ß‡∏¢
            selectSize(size, stock, btn); 
          };
          
          sizeContainer.appendChild(btn);
          
          // (6.2) JS: ‡∏´‡∏≤‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏Å‡∏î‡πÑ‡∏î‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠ auto-select
          if (stock > 0 && !firstAvailableButton) {
            firstAvailableButton = btn;
          }
        });

        // (6.3) JS: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏î‡πÑ‡∏î‡πâ (‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡πÅ‡∏Ñ‡πà‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß) ‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        if (sizeKeys.length === 1 || firstAvailableButton) {
            setTimeout(() => { 
               (firstAvailableButton || sizeContainer.querySelector('.size-btn')).click();
            }, 0);
        }
      } else {
        // ‡∏Å‡∏£‡∏ì‡∏µ‡∏™‡∏≥‡∏£‡∏≠‡∏á (‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ checkAndSeedData ‡πÉ‡∏´‡∏°‡πà)
        const btn = document.createElement('button');
        btn.className = 'size-btn active';
        btn.textContent = 'One Size (‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ?)';
        sizeContainer.appendChild(btn);
      }

      document.getElementById('qtyModal').style.display='flex';
    }
    // --- (6) JS: ‚≠êÔ∏è‚≠êÔ∏è [END] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Modal ‚≠êÔ∏è‚≠êÔ∏è ---


    // --- (7) JS: ‚≠êÔ∏è‚≠êÔ∏è [START] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ã‡∏™‡πå (selectSize) ‚≠êÔ∏è‚≠êÔ∏è ---
    function selectSize(size, stock, el) { // üëà ‡∏£‡∏±‡∏ö 'stock' ‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢
      currentSelectedSize = size;
      currentSelectedSizeStock = stock; // üëà ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡πÑ‡∏ã‡∏™‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      
      // (‡∏•‡∏ö .active ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏∑‡πà‡∏ô)
      document.querySelectorAll('#sizeSelector .size-btn').forEach(btn => btn.classList.remove('active'));
      el.classList.add('active');
      
      // (7.1) JS: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ
      // ‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ (currentQty) ‡∏°‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡πÑ‡∏ã‡∏™‡πå‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏Å‡∏î
      // ‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏±‡∏ö currentQty ‡∏•‡∏á‡∏°‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
      if (currentQty > stock && stock > 0) {
        currentQty = stock;
        document.getElementById('qtyDisplay').value = currentQty;
      } else if (stock === 0) {
        currentQty = 1; // ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô 1 (‡πÅ‡∏ï‡πà‡∏ï‡∏≠‡∏ô‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏∞‡πÄ‡∏î‡πâ‡∏á‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏°‡∏î)
        document.getElementById('qtyDisplay').value = 1;
      }
    }
    // --- (7) JS: ‚≠êÔ∏è‚≠êÔ∏è [END] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ã‡∏™‡πå ‚≠êÔ∏è‚≠êÔ∏è ---


    // --- (8) JS: ‚≠êÔ∏è‚≠êÔ∏è [START] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (changeQty) ‚≠êÔ∏è‚≠êÔ∏è ---
    function changeQty(n) {
      // (8.1) JS: ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏û‡∏î‡∏≤‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å
      let stockLimit = 99; // (‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ã‡∏™‡πå)
      
      if (currentSelectedSizeStock !== null) {
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ã‡∏™‡πå‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡πÑ‡∏ã‡∏™‡πå‡∏ô‡∏±‡πâ‡∏ô
        stockLimit = currentSelectedSizeStock;
      } else {
        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ã‡∏™‡πå ‡πÉ‡∏ä‡πâ totalStock (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ)
        const p = allProducts.find(x=>x.id===currentSelectedId);
        if (p) stockLimit = p.totalStock;
      }

      // (8.2) JS: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏û‡∏î‡∏≤‡∏ô
      if (currentQty + n >= 1 && currentQty + n <= stockLimit) {
        currentQty += n;
        document.getElementById('qtyDisplay').value = currentQty;
      } else if (currentQty + n > stockLimit) {
        showToast('‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏°‡∏µ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô ' + stockLimit + ' ‡∏ä‡∏¥‡πâ‡∏ô', true);
        currentQty = stockLimit; // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
        document.getElementById('qtyDisplay').value = currentQty;
      }
    }
    // --- (8) JS: ‚≠êÔ∏è‚≠êÔ∏è [END] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ‚≠êÔ∏è‚≠êÔ∏è ---

    
    // --- (9) JS: ‚≠êÔ∏è‚≠êÔ∏è [START] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ (submitToCart) ‚≠êÔ∏è‚≠êÔ∏è ---
    function submitToCart() {
      if (!currentSelectedSize) {
        return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ã‡∏™‡πå', true);
      }
      
      // (9.1) JS: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡πÑ‡∏ã‡∏™‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
      if (currentQty > currentSelectedSizeStock) {
        return showToast(`‡πÑ‡∏ã‡∏™‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${currentSelectedSizeStock} ‡∏ä‡∏¥‡πâ‡∏ô`, true);
      }
      if (currentSelectedSizeStock <= 0) {
         return showToast('‡πÑ‡∏ã‡∏™‡πå‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß', true);
      }
      
      const p = allProducts.find(x=>x.id===currentSelectedId);
      const ex = cart.find(x=>x.id===currentSelectedId && x.size === currentSelectedSize);
      
      if(ex) {
        // (9.2) JS: ‡πÄ‡∏ä‡πá‡∏Å‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
        if(ex.qty + currentQty <= currentSelectedSizeStock) {
          ex.qty += currentQty;
        } else { 
          ex.qty = currentSelectedSizeStock; 
          showToast('‡∏õ‡∏£‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß', true); 
        }
      } else {
        cart.push({...p, qty:currentQty, size: currentSelectedSize});
      }
      updateCart(); showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß'); closeModal('qtyModal');
    }
    // --- (9) JS: ‚≠êÔ∏è‚≠êÔ∏è [END] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ ‚≠êÔ∏è‚≠êÔ∏è ---


    // --- (10) JS: ‚≠êÔ∏è‚≠êÔ∏è [START] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ (adjustCartQty) ‚≠êÔ∏è‚≠êÔ∏è ---
    function adjustCartQty(idx, change) {
      const item = cart[idx];
      const product = allProducts.find(p => p.id === item.id);
      
      // (10.1) JS: ‡∏î‡∏∂‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡πÑ‡∏ã‡∏™‡πå‡∏ô‡∏±‡πâ‡∏ô‡πÜ
      const maxStock = product ? product.sizeStock[item.size] : item.qty; 
      
      let newQty = item.qty + change;
      if(newQty > maxStock) { 
        newQty = maxStock; 
        showToast('‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏°‡∏µ‡∏à‡∏≥‡∏Å‡∏±‡∏î ' + maxStock + ' ‡∏ä‡∏¥‡πâ‡∏ô', true); 
      }
      if(newQty < 1) newQty = 1;
      cart[idx].qty = newQty;
      openCart(); updateCart();
    }
    // --- (10) JS: ‚≠êÔ∏è‚≠êÔ∏è [END] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ ‚≠êÔ∏è‚≠êÔ∏è ---

    function updateCart() { document.getElementById('cartCount').innerText=cart.reduce((a,b)=>a+b.qty,0); }


    // ========== [START] ‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è ==========

    // --- (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á - [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß - ‡∏à‡∏≥‡∏Å‡∏±‡∏î N ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡∏Ñ‡∏ô]) ---
    async function applyCoupon() {
      const codeInput = document.getElementById('couponInput');
      const code = codeInput.value.trim().toUpperCase();
      if (!code) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î', true);

      // [‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°] 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Login ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
      if (userId.startsWith('guest_')) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î', true);
        return;
      }
      
      const btn = document.getElementById('couponBtn');
      btn.disabled = true; btn.innerText = '‡∏£‡∏≠...';
      
      try {
        const couponRef = db.collection('coupons').doc(code);
        const couponDoc = await couponRef.get();

        if (!couponDoc.exists) {
          showToast('‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', true);
          currentDiscount = { code: null, type: null, value: 0 };
        } else {
          const couponData = couponDoc.data();
          
          // [‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°] 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
          if (couponData.quantityUsed >= couponData.quantityAvailable) {
            showToast('‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß', true);
            currentDiscount = { code: null, type: null, value: 0 };
          } 
          // [‡πÉ‡∏´‡∏°‡πà] 3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏£‡∏ö‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
          else {
            // üëà [‡πÉ‡∏´‡∏°‡πà] ‡∏î‡∏∂‡∏á‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤ (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ô‡∏µ‡πâ ‡πÉ‡∏´‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô 1)
            const limitPerUser = couponData.limitPerUser || 1; 
            const usageRef = couponRef.collection('usersWhoUsed').doc(userId);
            const usageDoc = await usageRef.get();
            
            let currentUserUseCount = 0;
            if (usageDoc.exists) {
              currentUserUseCount = usageDoc.data().useCount || 0; // üëà [‡πÉ‡∏´‡∏°‡πà] ‡∏≠‡πà‡∏≤‡∏ô useCount
            }

            if (currentUserUseCount >= limitPerUser) { // üëà [‡πÉ‡∏´‡∏°‡πà] ‡πÄ‡∏ä‡πá‡∏Ñ‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤
              showToast('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏ö‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÅ‡∏•‡πâ‡∏ß', true);
              currentDiscount = { code: null, type: null, value: 0 };
            } else {
              // [‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à] ‡∏ñ‡πâ‡∏≤‡∏ú‡πà‡∏≤‡∏ô
              showToast('‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
              currentDiscount = { code: code, ...couponData };
            }
          }
        }
      } catch (e) {
        console.error("Error applying coupon:", e);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', true);
        currentDiscount = { code: null, type: null, value: 0 };
      } finally {
        btn.disabled = false; btn.innerText = '‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î';
        openCart(); // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
      }
    }

    // ‚≠êÔ∏è‚≠êÔ∏è [START] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô openCart() ‚≠êÔ∏è‚≠êÔ∏è
    function openCart() {
      const c = document.getElementById('cartItemsContainer'); 
      c.innerHTML = cart.length ? '' : '<p>‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</p>';
      subtotalAmount = 0; 
      cart.forEach((x,i) => { 
        subtotalAmount += (x.price * x.qty); 
        const sizeDisplay = (x.size && x.size !== 'One Size') ? ` (‡πÑ‡∏ã‡∏™‡πå: ${x.size})` : '';
        
        // [!!] ‡πÄ‡∏û‡∏¥‡πà‡∏° <img src="${x.image}" ...> ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
        c.innerHTML+=`
          <div class="cart-item">
            <img src="${x.image}" class="cart-item-img"> 
            
            <div class="cart-item-info">
              <b>${x.name}</b><span style="font-size: 0.9rem; color: #555;">${sizeDisplay}</span><br>
              <span style="color:var(--primary);">‡∏ø${x.price}</span>
              <div class="mini-qty-box">
                <button class="mini-qty-btn" onclick="adjustCartQty(${i}, -1)">-</button>
                <span class="mini-qty-val">${x.qty}</span>
                <button class="mini-qty-btn" onclick="adjustCartQty(${i}, 1)">+</button>
              </div>
            </div>
            <div class="cart-item-controls">
               <b style="margin-right:10px;">‡∏ø${x.price*x.qty}</b>
               <button onclick="cart.splice(${i},1);openCart();updateCart()" style="border:none;background:none;color:#999;cursor:pointer;"><i class="fas fa-trash"></i></button>
            </div>
          </div>`; 
      });

      // (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
      discountApplied = 0;
      const discountDisplay = document.getElementById('discountDisplay');
      if (currentDiscount.code && subtotalAmount > 0) {
        if (currentDiscount.type === 'percent') {
          discountApplied = (subtotalAmount * currentDiscount.value) / 100;
        } else if (currentDiscount.type === 'fixed') {
          discountApplied = currentDiscount.value;
        }
        if (discountApplied > subtotalAmount) {
          discountApplied = subtotalAmount;
        }
        finalTotalAmount = subtotalAmount - discountApplied; 
        document.getElementById('couponCodeDisplay').innerText = currentDiscount.code;
        document.getElementById('discountAmount').innerText = `-‡∏ø${discountApplied.toFixed(0)}`;
        discountDisplay.style.display = 'flex';
      } else {
        finalTotalAmount = subtotalAmount; 
        discountDisplay.style.display = 'none';
      }
      document.getElementById('subTotalPrice').innerText = '‡∏ø' + subtotalAmount;
      document.getElementById('totalPrice').innerText = '‡∏ø' + finalTotalAmount;
      document.getElementById('cartModal').style.display='flex';
    }
    // ‚≠êÔ∏è‚≠êÔ∏è [END] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô openCart() ‚≠êÔ∏è‚≠êÔ∏è
    
    // --- (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô - [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß]) ---
    function openPayment() { 
      if(!cart.length) return showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤', true);
      
      // ‚≠êÔ∏è --- [START] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£ Login --- ‚≠êÔ∏è
      // (userId ‡∏à‡∏∞‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ 'guest_' ‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ Login)
      if (userId.startsWith('guest_')) {
        
        // 1. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ Modal ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
        document.getElementById('confirmIcon').innerHTML = 'üë§'; // ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏£‡∏π‡∏õ‡∏Ñ‡∏ô
        document.getElementById('confirmTitle').innerText = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
        document.getElementById('confirmDesc').innerText = '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô ‡∏à‡∏∂‡∏á‡∏à‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ';
        
        // 2. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏° "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô"
        const btnConfirm = document.getElementById('btnConfirmAction');
        btnConfirm.innerText = '‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Login'; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏∏‡πà‡∏°
        
        // 3. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Action ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°
        btnConfirm.onclick = () => {
          window.location.href = 'index.html'; // ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ index.html
        };
        
        // 4. ‡πÅ‡∏™‡∏î‡∏á Modal
        document.getElementById('confirmModal').style.display = 'flex';
        
        // 5. ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏ï‡πà‡∏≠
        return; 
      }
      // ‚≠êÔ∏è --- [END] ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡πÇ‡∏Ñ‡πâ‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö --- ‚≠êÔ∏è

      // ‡∏ñ‡πâ‡∏≤ Login ‡πÅ‡∏•‡πâ‡∏ß (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°)
      document.getElementById('cartModal').style.display='none'; 
      document.getElementById('paymentModal').style.display='flex'; 
    }

    function toggleBank(s) { document.getElementById('bankDetails').style.display=s?'block':'none'; if(!s) document.getElementById('bankSelect').value=''; }
    function showQR() {
      const b=document.getElementById('bankSelect').value;
      document.getElementById('qrCodeContainer').style.display=b?'block':'none';
      if(b) document.getElementById('qrImage').src=`https://promptpay.io/0970482500/${finalTotalAmount}`;
    }
    

    // --- (11) JS: ‚≠êÔ∏è‚≠êÔ∏è [START] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (confirmOrder - ‡∏à‡∏≥‡∏Å‡∏±‡∏î N ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡∏Ñ‡∏ô) ‚≠êÔ∏è‚≠êÔ∏è ---
    async function confirmOrder() {
      const n=document.getElementById('custName').value, p=document.getElementById('custPhone').value, a=document.getElementById('custAddress').value;
      const pm=document.querySelector('input[name="payment"]:checked').value;
      const bankSelect = document.getElementById('bankSelect');
      const bankName = bankSelect ? bankSelect.value : '';

      // ‚≠êÔ∏è [START] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ ‚≠êÔ∏è
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "bank" (‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô) ‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      if (pm === 'bank') {
        showToast('‡πÇ‡∏õ‡∏£‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå', true);
        return; // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      }
      // ‚≠êÔ∏è [END] ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏° ‚≠êÔ∏è

      if(!n||!p||!a) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', true);
      // (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô ‡πÅ‡∏ï‡πà‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏ß‡πâ‡∏Å‡πá‡πÑ‡∏î‡πâ)
      if (pm === 'bank' && !bankName) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£', true);
      
      if (userId.startsWith('guest_')) {
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô', true);
          return;
      }

      const btn=document.getElementById('confirmPayBtn'); btn.disabled=true; btn.innerText="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
      try {
        // (11.1) JS: ‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
        await Promise.all(cart.map(i => db.runTransaction(async t => {
          const productRef = db.collection('products').doc(i.id);
          const d = await t.get(productRef);
          if(!d.exists) throw "‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö";
          
          const data = d.data();
          const newSizeStockMap = data.sizeStock; 
          const oldSizeStock = newSizeStockMap[i.size] || 0; 
          
          if (oldSizeStock < i.qty) {
             throw `‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${i.name} ‡πÑ‡∏ã‡∏™‡πå ${i.size} ‡πÑ‡∏°‡πà‡∏û‡∏≠`;
          }

          newSizeStockMap[i.size] = oldSizeStock - i.qty; 
          const newTotalStock = data.totalStock - i.qty; 
          const newSold = (data.sold || 0) + i.qty;

          t.update(productRef, {
            sizeStock: newSizeStockMap, 
            totalStock: newTotalStock, 
            sold: newSold
          });
        })));
        
        // (11.2) JS: [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏™‡∏£‡πâ‡∏≤‡∏á Transaction ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå + ‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á
        await db.runTransaction(async t => {
          
          // --- (A) ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ---
          if (currentDiscount.code) {
            const couponRef = db.collection('coupons').doc(currentDiscount.code);
            const couponDoc = await t.get(couponRef); 

            if (!couponDoc.exists) throw "‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
            const couponData = couponDoc.data();

            // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ß‡∏° (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
            if (couponData.quantityUsed >= couponData.quantityAvailable) {
              throw "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß";
            }
            
            // 2. [‡πÉ‡∏´‡∏°‡πà] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô Transaction)
            const limitPerUser = couponData.limitPerUser || 1; // üëà [‡πÉ‡∏´‡∏°‡πà]
            const usageRef = couponRef.collection('usersWhoUsed').doc(userId);
            const usageDoc = await t.get(usageRef); // üëà [‡πÉ‡∏´‡∏°‡πà]
            
            let currentUserUseCount = 0;
            if (usageDoc.exists) {
              currentUserUseCount = usageDoc.data().useCount || 0;
            }

            if (currentUserUseCount >= limitPerUser) { // üëà [‡πÉ‡∏´‡∏°‡πà]
              throw "‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏ö‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÅ‡∏•‡πâ‡∏ß";
            }
            
            // [‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à] ‡∏ñ‡πâ‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:
            // 1. ‡∏ï‡∏±‡∏î‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°
            t.update(couponRef, { quantityUsed: firebase.firestore.FieldValue.increment(1) });
            
            // 2. [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
            if (usageDoc.exists) {
              // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏¢‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï (‡∏ö‡∏ß‡∏Å 1)
              t.update(usageRef, { 
                useCount: firebase.firestore.FieldValue.increment(1),
                lastUsedAt: firebase.firestore.FieldValue.serverTimestamp() 
              });
            } else {
              // ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á (‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô 1)
              t.set(usageRef, { 
                useCount: 1, 
                lastUsedAt: firebase.firestore.FieldValue.serverTimestamp() 
              });
            }
          }
          
          // --- (B) ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
          const newOrderRef = db.collection('orders').doc(); 
          t.set(newOrderRef, {
            customer:{name:n,phone:p,address:a}, 
            items:cart,
            subtotal: subtotalAmount,
            discount: discountApplied,
            coupon: currentDiscount.code || '-',
            total: finalTotalAmount,
            paymentMethod:pm, 
            bank:pm==='bank'?bankName:'-', 
            user:userId, 
            status:'pending', 
            timestamp:firebase.firestore.FieldValue.serverTimestamp()
          });
        }); // --- ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î Transaction ---

        
        // (11.3) JS: ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÜ (‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
        sendMsgInternal(`[‡∏£‡∏∞‡∏ö‡∏ö] ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏¢‡∏≠‡∏î ‡∏ø${finalTotalAmount}`);
        
        cart=[]; 
        currentDiscount = { code: null, type: null, value: 0 };
        document.getElementById('couponInput').value = '';
        
        updateCart();
        closeModal('paymentModal');
        
        // ‚≠êÔ∏è [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ successModal ‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á ‚≠êÔ∏è
        document.querySelector('#successModal .confirm-title').innerText = '‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!';
        document.querySelector('#successModal .confirm-desc').innerText = '‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ‡∏ó‡∏≤‡∏á‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î';
        document.getElementById('successModal').querySelector('.btn-ok').onclick = () => {
             closeModal('successModal');
        };
        document.getElementById('successModal').style.display = 'flex';
        
      } catch(e){ 
        console.error("Order failed: ", e);
        showToast(typeof e === 'string' ? e : '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', true); 
      } finally { 
        btn.disabled=false; btn.innerText="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠"; 
      }
    }
    // --- (11) JS: ‚≠êÔ∏è‚≠êÔ∏è [END] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ ‚≠êÔ∏è‚≠êÔ∏è ---

    // ========== [END] ‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è ==========


    
    // --- (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ ‡πÅ‡∏•‡∏∞ Chat) ---
    
    // ‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è [START] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô openHistory ‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è
    async function openHistory() {
      document.getElementById('historyModal').style.display = 'flex';
      const con = document.getElementById('historyContainer');
      con.innerHTML = '<p style="text-align:center;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>';
      
      // [FIX 1] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Login ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
      if (userId.startsWith('guest_')) {
           con.innerHTML = '<p style="text-align:center; color:#999;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</p>';
           return;
      }

      const s = await db.collection('orders').where('user', '==', userId).get();
      if(s.empty) return con.innerHTML = '<p style="text-align:center; color:#999;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</p>';
      
      let ords = []; 
      // ‚≠êÔ∏è [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á o.id ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô array
      s.forEach(d => ords.push({ id: d.id, ...d.data() })); 
      
      ords.sort((a,b)=>(b.timestamp?.seconds||0)-(a.timestamp?.seconds||0));
      con.innerHTML = '';
      
      ords.forEach(o => {
        let items = ''; 
        o.items.forEach(i => {
          const sizeDisplay = (i.size && i.size !== 'One Size') ? ` (‡πÑ‡∏ã‡∏™‡πå: ${i.size})` : '';
          
          // [FIX 2] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Bug: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å i.price*x.qty ‡πÄ‡∏õ‡πá‡∏ô i.price*i.qty
          items += `<div class="item-row"><span>${i.name}${sizeDisplay} x${i.qty}</span><span>‡∏ø${i.price*i.qty}</span></div>`; 
        });
        
        // ‚≠êÔ∏è [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ 'cancelled'
        let statusText = '‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏™‡πà‡∏á';
        let statusColor = 'var(--primary)';
        if (o.status === 'completed') {
          statusText = '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
          statusColor = 'green';
        } else if (o.status === 'cancelled') {
          statusText = '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å';
          statusColor = '#d93025'; // ‡∏™‡∏µ‡πÅ‡∏î‡∏á
        }
        
        // ‚≠êÔ∏è‚≠êÔ∏è [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å ‡πÅ‡∏•‡∏∞ "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà" ‚≠êÔ∏è‚≠êÔ∏è
        let orderActionsHtml = '';
        if (o.status === 'pending') {
          // (‡πÉ‡∏ä‡πâ single quote ‡∏£‡∏≠‡∏ö onclick ‡πÅ‡∏•‡∏∞ double quote ‡∏£‡∏≠‡∏ö string parameter)
          orderActionsHtml = `
            <div class="order-total-actions">
              <button class="btn-edit-order" id="editBtn-${o.id}" onclick='openEditAddressModal("${o.id}", ${JSON.stringify(o.customer)})'>
                ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà
              </button>
              <button class="btn-cancel-order" id="cancelBtn-${o.id}" onclick='cancelOrder("${o.id}", ${JSON.stringify(o.items)})'>
                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
              </button>
            </div>`;
        }
        
        // ‚≠êÔ∏è [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ statusText, statusColor, ‡πÅ‡∏•‡∏∞ orderActionsHtml
        con.innerHTML += `
          <div class="order-card">
            <div class="order-header">
              <span>üìÖ ${o.timestamp?new Date(o.timestamp.seconds*1000).toLocaleString('th-TH'):'-'}</span>
              <span class="order-status" style="color:${statusColor}">${statusText}</span>
            </div>
            <div class="order-items">${items}</div>
            <div class="order-total">
              <span>‡∏£‡∏ß‡∏°: ‡∏ø${o.total}</span>
              ${orderActionsHtml}
            </div>
          </div>`;
      });
    }
    // ‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è [END] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô openHistory ‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è
    
    
    // ‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è [START] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô cancelOrder ‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è
    async function cancelOrder(orderId, items) {
      // 1. ‡∏ñ‡∏≤‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
      document.getElementById('confirmIcon').innerHTML = 'üóëÔ∏è';
      document.getElementById('confirmTitle').innerText = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å?';
      document.getElementById('confirmDesc').innerText = '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö';
      const btnConfirm = document.getElementById('btnConfirmAction');
      btnConfirm.innerText = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å';
      
      btnConfirm.onclick = async () => {
        closeModal('confirmModal');
        const cancelBtn = document.getElementById(`cancelBtn-${orderId}`);
        if (cancelBtn) {
          cancelBtn.disabled = true;
          cancelBtn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å...';
        }
        
        try {
          // 2. ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Transaction)
          // ‡πÉ‡∏ä‡πâ Promise.all ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ó‡∏∏‡∏Å‡∏ä‡∏¥‡πâ‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
          await Promise.all(items.map(item => db.runTransaction(async t => {
            const productRef = db.collection('products').doc(item.id);
            const doc = await t.get(productRef);
            
            if (!doc.exists) {
              // ‡∏ñ‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡πá‡πÅ‡∏Ñ‡πà‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ
              console.warn(`Product ${item.id} not found, skipping stock return.`);
              return; 
            }
            
            const data = doc.data();
            const newSizeStockMap = data.sizeStock;
            const oldSizeStock = newSizeStockMap[item.size] || 0;
            
            // ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å
            newSizeStockMap[item.size] = oldSizeStock + item.qty;
            const newTotalStock = data.totalStock + item.qty;
            // ‡∏•‡∏î '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢' (sold)
            const newSold = Math.max(0, (data.sold || 0) - item.qty); 
            
            t.update(productRef, {
              sizeStock: newSizeStockMap,
              totalStock: newTotalStock,
              sold: newSold
            });
          })));

          // 3. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏õ‡πá‡∏ô 'cancelled'
          await db.collection('orders').doc(orderId).update({
            status: 'cancelled'
          });

          showToast('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
          
          // 4. ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
          openHistory(); 
          
        } catch (e) {
          console.error("Error cancelling order: ", e);
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message, true);
          if (cancelBtn) {
            cancelBtn.disabled = false;
            cancelBtn.innerText = '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå';
          }
        }
      };
      
      // 5. ‡πÅ‡∏™‡∏î‡∏á Modal ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
      document.getElementById('confirmModal').style.display = 'flex';
    }
    // ‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è [END] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô cancelOrder ‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è
    
    
    function openEditAddressModal(orderId, customer) {
      if (!customer) return; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô error
      
      currentEditingOrderId = orderId; // 1. ‡πÄ‡∏Å‡πá‡∏ö ID ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ global
      
      // 2. ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏•‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á input
      document.getElementById('editCustName').value = customer.name || '';
      document.getElementById('editCustPhone').value = customer.phone || '';
      document.getElementById('editCustAddress').value = customer.address || '';
      
      // 3. ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á Modal
      document.getElementById('editAddressModal').style.display = 'flex';
    }
    
    async function saveAddress() {
      if (!currentEditingOrderId) return; // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ ID ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏Å‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      
      const btn = document.getElementById('saveAddressBtn');
      btn.disabled = true;
      btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";

      // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å input
      const newName = document.getElementById('editCustName').value.trim();
      const newPhone = document.getElementById('editCustPhone').value.trim();
      const newAddress = document.getElementById('editCustAddress').value.trim();

      // 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏£‡∏ö
      if (!newName || !newPhone || !newAddress) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', true);
        btn.disabled = false;
        btn.innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á";
        return;
      }
      
      // 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á object ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏´‡∏°‡πà
      const newCustomerData = {
        name: newName,
        phone: newPhone,
        address: newAddress
      };

      try {
        // 4. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Firestore
        await db.collection('orders').doc(currentEditingOrderId).update({
          customer: newCustomerData
        });
        
        showToast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        closeModal('editAddressModal');
        currentEditingOrderId = null; // 5. ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå ID
        openHistory(); // 6. ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
        
      } catch (e) {
        console.error("Error updating address: ", e);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message, true);
      } finally {
        btn.disabled = false;
        btn.innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á";
      }
    }
    function toggleChat() { const w=document.getElementById('chatWindow'); w.style.display=w.style.display==='none'?'flex':'none'; if(w.style.display==='flex') scrollToBottom(); }
    function scrollToBottom() { const b=document.getElementById('chatBody'); b.scrollTop=b.scrollHeight; }
    function handleEnter(e) { if(e.key==='Enter') sendMsg(); }
    function sendMsg() {
      const txt = document.getElementById('msgInput').value.trim();
      if(!txt) return;
      document.getElementById('msgInput').value = '';
      sendMsgInternal(txt);
    }
    
    // üî• --- [START] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô sendMsgInternal --- üî•
    function sendMsgInternal(text) {
      
      // üî• [NEW] 1. ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï Timer 30 ‡∏ô‡∏≤‡∏ó‡∏µ (‡∏•‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á)
      if (inactivityTimer) {
        clearTimeout(inactivityTimer);
      }
      
      // (1) ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏õ‡∏ó‡∏µ‡πà messages sub-collection
      db.collection('chats').doc(userId).collection('messages').add({ 
        text: text, 
        sender: 'user', 
        timestamp: firebase.firestore.FieldValue.serverTimestamp() 
      });
      
      // (2) üî• ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡πÅ‡∏ä‡∏ó (‡πÄ‡∏û‡∏¥‡πà‡∏° displayName ‡πÅ‡∏•‡∏∞ photoURL)
      db.collection('chats').doc(userId).set({
        lastMessage: text,
        lastActive: firebase.firestore.FieldValue.serverTimestamp(),
        userId: userId,
        // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å currentUserData ‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤‡∏ï‡∏≠‡∏ô login
        email: currentUserData.email || (document.getElementById('custName').value || 'Guest'),
        displayName: currentUserData.displayName || (document.getElementById('custName').value || 'Guest'),
        photoURL: currentUserData.photoURL || null
      }, { merge: true }); // ‡πÉ‡∏ä‡πâ merge: true ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ isBlocked (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
      
      // (3) ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Auto-reply
      setTimeout(() => autoReply(text), 1000);
      
      // üî• [NEW] 2. ‡πÄ‡∏£‡∏¥‡πà‡∏° Timer 30 ‡∏ô‡∏≤‡∏ó‡∏µ‡πÉ‡∏´‡∏°‡πà
      inactivityTimer = setTimeout(() => {
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏ö 30 ‡∏ô‡∏≤‡∏ó‡∏µ
        sendInactivityMessage();
      }, INACTIVITY_TIMEOUT_MS);
    }
    // üî• --- [END] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô sendMsgInternal --- üî•

    // üî• --- [NEW] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏ô‡∏≤‡∏ô --- üî•
    function sendInactivityMessage() {
      const followUpMsg = {
        text: "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏ô‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏≠‡∏≤‡∏à‡∏ï‡∏¥‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡πà‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà ‡∏à‡∏∞‡∏£‡∏µ‡∏ö‡∏°‡∏≤‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÇ‡∏î‡∏¢‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡∏£‡∏±‡∏ö üôè",
        sender: 'admin',
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•
      db.collection('chats').doc(userId).collection('messages').add(followUpMsg);
      
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï lastActive (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ä‡∏ó‡πÄ‡∏î‡πâ‡∏á‡πÑ‡∏õ‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô‡∏ù‡∏±‡πà‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)
      db.collection('chats').doc(userId).set({ 
          lastActive: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
      
      // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå Timer (‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏™‡πà‡∏á‡πÅ‡∏Ñ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
      inactivityTimer = null;
    }
    // üî• --- [END] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà --- üî•


    // (‡πÉ‡∏´‡∏°‡πà!) ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    function handleOptionClick(optionText, messageId) {
      // 1. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
      // (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô sendMsgInternal ‡∏à‡∏∞‡πÑ‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å autoReply ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
      sendMsgInternal(optionText);

      // 2. ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏° (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß")
      const optionsContainer = document.getElementById(`options-${messageId}`);
      if (optionsContainer) {
        optionsContainer.innerHTML = `<div class="option-btn-selected">(‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ${optionText})</div>`;
      }
    }

    // üî• --- [START] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô autoReply (‡πÄ‡∏û‡∏¥‡πà‡∏° Logic 20 ‡∏ô‡∏≤‡∏ó‡∏µ) --- üî•
    async function autoReply(t) {
      
      // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏ä‡∏ó
      let welcomeHasBeenSent = false;
      let welcomeSentTime = null; // üëà [NEW] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏ß‡∏•‡∏≤
      let chatData = {};

      try {
        const chatDoc = await db.collection('chats').doc(userId).get();
        if (chatDoc.exists) {
          chatData = chatDoc.data(); 
          welcomeHasBeenSent = chatData.welcomeSent === true;
          welcomeSentTime = chatData.welcomeSentTime || null; // üëà [NEW] ‡∏î‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏≠‡∏ó‡∏ï‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        }
      } catch (e) {
        console.error("Error checking welcome flags:", e);
        welcomeHasBeenSent = true; // ‡∏Å‡∏±‡∏ô‡∏û‡∏•‡∏≤‡∏î (‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡πà‡∏á welcome)
      }

      let r=''; t=t.toLowerCase();

      // 2. üëà [NEW] ‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö
      let shouldSendWelcome = false;
      if (!welcomeHasBeenSent) {
        // (A) ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏™‡πà‡∏á‡πÄ‡∏•‡∏¢ (welcomeSent: false)
        shouldSendWelcome = true;
      } else if (welcomeSentTime) {
        // (B) ‡πÄ‡∏Ñ‡∏¢‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ö‡∏≠‡∏ó‡∏ï‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ô‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
        const now = new Date();
        const lastBotReplyTime = welcomeSentTime.toDate();
        const diffMs = now - lastBotReplyTime;
        const diffMins = diffMs / (1000 * 60); // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏≤‡∏ó‡∏µ

        if (diffMins > 20) { // üëà ‡∏ñ‡πâ‡∏≤‡∏ö‡∏≠‡∏ó‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏≠‡∏ö‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏•‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô 20 ‡∏ô‡∏≤‡∏ó‡∏µ
          shouldSendWelcome = true; // ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á Welcome ‡πÉ‡∏´‡∏°‡πà
        }
      } else {
        // (C) ‡∏Å‡∏£‡∏ì‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤ (welcomeSent: true ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ welcomeSentTime)
        // ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÄ‡∏•‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà
        shouldSendWelcome = true;
      }
      
      // 3. üëà [MODIFIED] ‡∏ñ‡πâ‡∏≤‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤ "‡∏Ñ‡∏ß‡∏£‡∏™‡πà‡∏á"
      if (shouldSendWelcome) {
        const welcomeMsg = {
          sender: 'admin',
          text: '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö? ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö',
          type: 'options', 
          options: ['‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏±‡∏î‡∏™‡πà‡∏á', '‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÜ'], 
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡∏û‡∏¥‡πÄ‡∏®‡∏© (‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏°)
        db.collection('chats').doc(userId).collection('messages').add(welcomeMsg);
        
        // 4. "‡∏ï‡∏±‡πâ‡∏á‡∏ò‡∏á" (set flag) ‡πÅ‡∏•‡∏∞ "‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤" (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏≠‡∏ó‡∏ï‡∏≠‡∏ö)
        db.collection('chats').doc(userId).set({ 
            lastActive: firebase.firestore.FieldValue.serverTimestamp(),
            welcomeSent: true, // üëà ‡∏ï‡∏±‡πâ‡∏á‡∏ò‡∏á
            welcomeSentTime: firebase.firestore.FieldValue.serverTimestamp() // üëà [NEW] ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤
        }, { merge: true });
        
        return; // ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô
      }

      // 5. (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ‡∏ñ‡πâ‡∏≤ "‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡∏™‡πà‡∏á" (‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤) ‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πá‡∏Ñ keyword
      if(t.includes('‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤')) r='‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö';
      if(t.includes('‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ß‡∏±‡∏ô‡πÑ‡∏´‡∏ô')) r='‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏Ñ‡∏£‡∏±‡∏ö'; 
      if(t.includes('‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏±‡∏î‡∏™‡πà‡∏á')) r='‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏ô‡∏π "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠" ‡∏Ñ‡∏£‡∏±‡∏ö';
      if(t.includes('‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÜ')) r='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏ß‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö';

      // 6. (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö (r) ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ
      if(r) {
         db.collection('chats').doc(userId).collection('messages').add({text:r, sender:'admin', timestamp:firebase.firestore.FieldValue.serverTimestamp()});
         
         // 7. üëà [NEW] ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ö‡∏≠‡∏ó‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏ß‡∏¢
         // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ timer 20 ‡∏ô‡∏≤‡∏ó‡∏µ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ
         db.collection('chats').doc(userId).set({ 
             lastActive: firebase.firestore.FieldValue.serverTimestamp(),
             welcomeSentTime: firebase.firestore.FieldValue.serverTimestamp() // üëà [NEW] ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤
         }, { merge: true });
      }
    }
    // üî• --- [END] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô autoReply --- üî•

    
    // üî• --- [NEW] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏±‡∏Å‡∏ü‡∏±‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ö‡∏•‡πá‡∏≠‡∏Ñ --- üî•
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏Ñ‡∏≠‡∏¢‡∏ü‡∏±‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ 'chats/{userId}'
    function listenToChatStatus() {
      if (!userId) return; // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ userId ‡∏Å‡πá‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£

      db.collection('chats').doc(userId).onSnapshot(doc => {
        const msgInput = document.getElementById('msgInput');
        const sendBtn = document.querySelector('.chat-input-area button'); // ‡∏´‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á

        if (doc.exists) {
          const chatData = doc.data();
          const isBlocked = chatData.isBlocked || false; // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ isBlocked (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô false)

          if (isBlocked) {
            // ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Ñ
            msgInput.disabled = true;
            msgInput.placeholder = "‚ùå ‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°";
            if (sendBtn) sendBtn.disabled = true;
            
            // üî• [NEW] ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Ñ ‡πÉ‡∏´‡πâ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å Timer 30 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏î‡πâ‡∏ß‡∏¢
            if (inactivityTimer) clearTimeout(inactivityTimer);
            
          } else {
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Ñ (‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏π‡∏Å‡∏õ‡∏•‡∏î‡∏ö‡∏•‡πá‡∏≠‡∏Ñ)
            msgInput.disabled = false;
            msgInput.placeholder = "‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...";
            if (sendBtn) sendBtn.disabled = false;
          }
        } else {
          // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á (‡πÄ‡∏ä‡πà‡∏ô ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡πÅ‡∏ä‡∏ó) ‡∏Å‡πá‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
          msgInput.disabled = false;
          msgInput.placeholder = "‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...";
          if (sendBtn) sendBtn.disabled = false;
        }
      });
    }
    
    // üî• --- [START] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô listenToChat --- üî•
    function listenToChat() {
      db.collection('chats').doc(userId).collection('messages').orderBy('timestamp').onSnapshot(s => {
        const b=document.getElementById('chatBody'); b.innerHTML='<div class="msg msg-admin">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö!</div>';
        
        let hasAdminReply = false; // (1) ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏ä‡πá‡∏Å‡∏ß‡πà‡∏≤‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏≠‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
        
        s.forEach(d=> {
          const data = d.data();
          const msgId = d.id; // üëà (‡πÉ‡∏´‡∏°‡πà) ‡∏î‡∏∂‡∏á ID ‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
          let optionsHtml = '';
          
          // (2) ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å 'admin' (‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡πÅ‡∏£‡∏Å‡∏™‡∏∏‡∏î)
          if (data.sender === 'admin' && data.text !== '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö!') {
            hasAdminReply = true;
          }

          // (‡πÉ‡∏´‡∏°‡πà) ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡∏°‡∏µ "‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
          if (data.type === 'options' && data.options && data.options.length > 0) {
            // (‡πÉ‡∏´‡∏°‡πà) ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°
            optionsHtml = `<div class="msg-options" id="options-${msgId}">`; // üëà (‡πÉ‡∏´‡∏°‡πà) ‡πÉ‡∏™‡πà ID ‡πÉ‡∏´‡πâ container
            data.options.forEach(opt => {
              // (‡πÉ‡∏´‡∏°‡πà) ‡πÄ‡∏û‡∏¥‡πà‡∏° onclick ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°
              optionsHtml += `<button class="option-btn" onclick="handleOptionClick('${opt}', '${msgId}')">${opt}</button>`;
            });
            optionsHtml += `</div>`;
          }

          // (‡πÉ‡∏´‡∏°‡πà) ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏£‡πà‡∏≤‡∏á HTML ‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡πÄ‡∏û‡∏¥‡πà‡∏° optionsHtml ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ)
          b.innerHTML+=`
            <div class="msg ${data.sender==='user'?'msg-user':'msg-admin'}">
              ${data.text}
              ${optionsHtml} 
            </div>`;
        });
        
        // (3) ‡∏ñ‡πâ‡∏≤‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å Timer
        if (hasAdminReply && inactivityTimer) {
            console.log("Admin replied, cancelling 30-min timer.");
            clearTimeout(inactivityTimer);
            inactivityTimer = null; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        }
        
        scrollToBottom();
      });
    }
    // üî• --- [END] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô listenToChat --- üî•

    function closeModal(id){document.getElementById(id).style.display='none';}
    function showToast(text, isError = false){
      const t=document.getElementById('toast');
      t.querySelector('span').innerText = text;
      if(isError) {
        t.classList.add('error');
        t.querySelector('i').className = "fas fa-exclamation-circle";
      } else {
        t.classList.remove('error');
        t.querySelector('i').className = "fas fa-check-circle";
      }
      t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), 2500);
    }
  </script>
</body>
</html>
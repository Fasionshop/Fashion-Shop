<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Chat Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Mitr:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    /* üî• ‡πÉ‡∏ä‡πâ‡∏ü‡∏≠‡∏ô‡∏ï‡πå Mitr üî• */
    body { font-family: 'Mitr', sans-serif; margin: 0; display: flex; height: 100vh; background: #f0f2f5; font-size: 16px; }
    
    /* Sidebar */
    .sidebar { width: 320px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
    .sidebar-header { padding: 20px; background: #7A56D3; color: white; font-weight: 600; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 10; } /* üëà ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ */
    .user-list { flex: 1; overflow-y: auto; }
    
    .user-item { 
      padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; 
      display: flex; align-items: center; gap: 12px; transition: 0.2s; 
    }
    .user-item:hover { background: #F3F0FF; } /* üëà ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ */
    .user-item.active { background: #E9E4FF; border-left: 5px solid #7A56D3; } /* üëà ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ */
    
    .user-avatar { 
      width: 45px; height: 45px; background: #eee; border-radius: 50%; 
      display: flex; justify-content: center; align-items: center; 
      color: #888; font-size: 1.2rem; flex-shrink: 0;
      overflow: hidden; /* üî• [NEW] ‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏•‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö */
    }
    .user-avatar-img { /* üî• [NEW] ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå */
      width: 100%; height: 100%; object-fit: cover;
    }
    .user-info { flex: 1; min-width: 0; }
    .user-name { font-weight: 600; color: #333; font-size: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-preview { font-size: 0.9rem; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-time { font-size: 0.75rem; color: #aaa; margin-top: 2px; }
    .blocked-tag { /* üî• [NEW] ‡∏õ‡πâ‡∏≤‡∏¢ '‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Ñ' */
      font-size: 0.8rem;
      color: #d93025;
      font-weight: 600;
      margin-left: 5px;
    }

    /* Chat Area */
    .chat-area { flex: 1; display: flex; flex-direction: column; background: #fff; }
    .chat-area-header { 
      padding: 15px 20px; border-bottom: 1px solid #ddd; font-weight: 600; 
      background: #f9f9f9; display: flex; align-items: center; 
      justify-content: flex-start; /* üî• [CHANGED] ‡∏à‡∏±‡∏î‡∏ä‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢ */
      gap: 15px; /* üî• [NEW] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á */
    }
    .header-avatar-container { /* üî• [NEW] ‡∏ó‡∏µ‡πà‡πÉ‡∏™‡πà‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô Header */
      width: 40px; height: 40px; background: #eee; border-radius: 50%;
      display: flex; justify-content: center; align-items: center;
      font-size: 1.8rem; color: #ccc; overflow: hidden;
      flex-shrink: 0;
    }
    .header-avatar-container img { /* üî• [NEW] ‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô Header */
      width: 100%; height: 100%; object-fit: cover;
    }
    .block-btn { /* üî• [NEW] ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏•‡πá‡∏≠‡∏Ñ */
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      background: #d93025;
      color: white;
      cursor: pointer;
      font-family: 'Mitr', sans-serif;
      font-weight: 600;
      font-size: 0.9rem;
      transition: 0.2s;
      margin-left: auto; /* üî• [NEW] ‡∏î‡∏±‡∏ô‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ */
    }
    .block-btn:hover { background: #b0271e; }
    .block-btn.is-blocked { /* üî• [NEW] ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏≠‡∏ô‡∏õ‡∏•‡∏î‡∏ö‡∏•‡πá‡∏≠‡∏Ñ */
      background: #f0ad4e;
    }
    .block-btn.is-blocked:hover { background: #df9e3c; }
    
    .messages-box { flex: 1; padding: 20px; overflow-y: auto; background: #fff; display: flex; flex-direction: column; gap: 10px; }
    
    /* Input Area */
    .input-box { padding: 20px; border-top: 1px solid #ddd; display: flex; gap: 10px; background: #f0f0f0; }
    /* üî• ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÄ‡∏õ‡πá‡∏ô Mitr üî• */
    .input-box input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 25px; outline: none; padding-left: 20px; font-family: 'Mitr', sans-serif; font-size: 1rem; }
    /* üî• ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÄ‡∏õ‡πá‡∏ô Mitr üî• */
    .input-box button { padding: 10px 25px; background: #7A56D3; color: white; border: none; border-radius: 25px; cursor: pointer; font-weight: 600; transition: 0.2s; font-family: 'Mitr', sans-serif; } /* üëà ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ */
    .input-box button:hover { background: #5E42A6; } /* üëà ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ */
    .input-box button:disabled { background: #ccc; cursor: not-allowed; }

    /* Message Bubbles */
    .msg { padding: 10px 15px; border-radius: 15px; max-width: 70%; word-wrap: break-word; line-height: 1.4; position: relative; animation: fadeIn 0.2s; font-size: 1rem; }
    @keyframes fadeIn { from{opacity:0; transform:translateY(5px);} to{opacity:1; transform:translateY(0);} }
    .msg-admin { background: #7A56D3; color: white; align-self: flex-end; border-bottom-right-radius: 2px; } /* üëà ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ */
    .msg-user { background: #f1f1f1; color: #333; align-self: flex-start; border-bottom-left-radius: 2px; }
    
    .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #ccc; }
    .empty-state i { font-size: 3rem; margin-bottom: 10px; }
    
    /* üî• [NEW] CSS for Custom Confirm Modal */
    .modal { 
      display: none; 
      position: fixed; 
      top: 0; left: 0; 
      width: 100%; height: 100%; 
      background: rgba(0,0,0,0.5); 
      z-index: 1000; 
      /* üî• [NEW] Changed to align center */
      justify-content: center; 
      align-items: center; 
    }
    .confirm-modal-box { 
      background: white; 
      padding: 25px; 
      border-radius: 10px; 
      text-align: center; 
      width: 90%; 
      max-width: 350px; 
      animation: popIn 0.3s; 
    }
    @keyframes popIn { 
      from { transform: scale(0.8); opacity: 0; } 
      to { transform: scale(1); opacity: 1; } 
    }
    .confirm-icon { font-size: 3rem; margin-bottom: 15px; display: block; }
    .confirm-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; color: #333; }
    .confirm-desc { font-size: 0.95rem; color: #666; margin-bottom: 20px; }
    .confirm-actions { display: flex; gap: 10px; justify-content: center; }
    .btn-confirm-action { 
      flex: 1; padding: 10px; border: none; 
      border-radius: 5px; cursor: pointer; 
      font-family: 'Mitr'; font-weight: 600; 
    }
    .btn-yes { 
      /* üî• [MODIFIED] Hardcoded color */
      background: #7A56D3; 
      color: white; 
    }
    .btn-no { background: #eee; color: #333; }
    /* üî• [End of new CSS] */

  </style>
</head>
<body>

  <div class="sidebar">
    <div class="sidebar-header">
      <span><i class="fas fa-comments"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏ó</span>
      <small style="cursor:pointer; font-size:0.85rem; opacity:0.8;" onclick="location.reload()"><i class="fas fa-sync"></i> ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î</small>
    </div>
    <div class="user-list" id="userList">
      <div style="padding:20px; text-align:center; color:#999;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠...</div>
    </div>
  </div>

  <div class="chat-area">
    <div class="chat-area-header">
      <div class="header-avatar-container" id="chatHeaderAvatar">
        <i class="far fa-comment-dots" style="font-size: 1.5rem;"></i>
      </div>
      <div>
        <span id="chatHeaderName" style="display: block; line-height: 1.2;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ä‡∏ó‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏ô‡∏ó‡∏ô‡∏≤</span>
        <span id="chatHeaderId" style="font-size:0.9rem; color:#999; font-weight:normal;"></span>
      </div>
      <button id="blockBtn" onclick="toggleBlockUser()" style="display: none;" class="block-btn">
        <i class="fas fa-ban"></i> ‡∏ö‡∏•‡πá‡∏≠‡∏Ñ
      </button>
    </div>
    <div class="messages-box" id="messagesBox">
      <div class="empty-state">
        <i class="far fa-comment-dots"></i>
        <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏ó</p>
      </div>
    </div>
    <div class="input-box">
      <input type="text" id="adminInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö..." disabled onkeypress="handleEnter(event)">
      <button id="sendBtn" onclick="sendReply()" disabled><i class="fas fa-paper-plane"></i> ‡∏™‡πà‡∏á</button>
    </div>
  </div>

  <div id="confirmModal" class="modal">
    <div class="confirm-modal-box">
      <div id="confirmIcon" class="confirm-icon">‚ùì</div>
      <div id="confirmTitle" class="confirm-title">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô?</div>
      <div id="confirmDesc" class="confirm-desc">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...</div>
      <div class="confirm-actions">
        <button class="btn-confirm-action btn-no" onclick="closeModal('confirmModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="btn-confirm-action btn-yes" id="btnConfirmAction">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

  <script>
    // --- (Firebase Config) ---
    const firebaseConfig = {
      apiKey: "AIzaSyA7lELq82KxJ0sFDf6jKmWPDFKpKqHJp0c",
      authDomain: "king007-c72e2.firebaseapp.com",
      projectId: "king007-c72e2",
      storageBucket: "king007-c72e2.firebasestorage.app",
      messagingSenderId: "136587774092",
      appId: "1:136587774092:web:4ee67ff03cdee67bb393a9",
      measurementId: "G-K39CYF7766"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let currentChatId = null;
    let unsubscribeMsg = null;
    let currentUserData = null; 
    let confirmAction = null; // üî• [NEW] Store the confirm action

    db.collection('chats').onSnapshot(snapshot => {
      const userList = document.getElementById('userList');
      const users = [];
      snapshot.forEach(doc => { users.push({ id: doc.id, ...doc.data() }); });
      
      users.sort((a, b) => {
        const timeA = a.lastActive ? a.lastActive.seconds : 0;
        const timeB = b.lastActive ? b.lastActive.seconds : 0;
        return timeB - timeA;
      });

      if (currentChatId) {
        const updatedCurrentUserData = users.find(u => u.id === currentChatId);
        if (updatedCurrentUserData) {
          currentUserData = updatedCurrentUserData; 
          updateBlockButtonState(currentUserData.isBlocked); 
          document.getElementById('adminInput').disabled = currentUserData.isBlocked || false;
          document.getElementById('sendBtn').disabled = currentUserData.isBlocked || false;
        }
      }
      
      userList.innerHTML = '';
      if (users.length === 0) {
        userList.innerHTML = '<div style="padding:30px; text-align:center; color:#ccc;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡∏Å‡∏°‡∏≤</div>';
        return;
      }

      users.forEach(u => {
        const div = document.createElement('div');
        div.className = `user-item ${currentChatId === u.id ? 'active' : ''}`;
        div.onclick = () => selectChat(u, div); 
        
        let timeStr = "";
        if(u.lastActive) {
          const date = u.lastActive.toDate();
          timeStr = date.getHours() + ":" + date.getMinutes().toString().padStart(2, '0');
        }
        
        const displayName = u.displayName || (u.email ? u.email.split('@')[0] : `Guest (${u.id.substr(0,4)})`);
        
        const avatarImg = u.photoURL 
            ? `<img src="${u.photoURL}" class="user-avatar-img">` 
            : `<i class="fas fa-user"></i>`;
            
        const blockedIndicator = u.isBlocked ? '<span class="blocked-tag">(‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Ñ)</span>' : '';

        div.innerHTML = `
          <div class="user-avatar">${avatarImg}</div>
          <div class="user-info">
            <div style="display:flex; justify-content:space-between;">
              <div class="user-name">${displayName}${blockedIndicator}</div>
              <div class="user-time">${timeStr}</div>
            </div>
            <div class="user-preview">${u.lastMessage || '‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û/‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå'}</div>
          </div>
        `;
        userList.appendChild(div);
      });
    });

    function selectChat(u, element) { 
      currentChatId = u.id;
      currentUserData = u; 
      
      document.querySelectorAll('.user-item').forEach(e => e.classList.remove('active'));
      element.classList.add('active');

      const avatarHeader = document.getElementById('chatHeaderAvatar');
      if (u.photoURL) {
        avatarHeader.innerHTML = `<img src="${u.photoURL}" alt="avatar">`;
      } else {
        avatarHeader.innerHTML = `<i class="fas fa-user-circle" style="font-size: 1.8rem; color: #ccc;"></i>`;
      }

      const displayName = u.displayName || (u.email ? u.email.split('@')[0] : `Guest (${u.id.substr(0,4)})`);
      document.getElementById('chatHeaderName').innerText = displayName;
      document.getElementById('chatHeaderId').innerText = `(ID: ${u.id})`;
      
      const blockBtn = document.getElementById('blockBtn');
      blockBtn.style.display = 'inline-block';
      updateBlockButtonState(u.isBlocked);
      
      document.getElementById('adminInput').disabled = u.isBlocked || false;
      document.getElementById('sendBtn').disabled = u.isBlocked || false;

      if(unsubscribeMsg) unsubscribeMsg();
      const box = document.getElementById('messagesBox');
      unsubscribeMsg = db.collection('chats').doc(u.id).collection('messages')
        .orderBy('timestamp')
        .onSnapshot(snap => {
          box.innerHTML = '';
          if(snap.empty) {
            box.innerHTML = '<div class="empty-state"><p>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</p></div>';
            return;
          }
          snap.forEach(doc => {
            const msg = doc.data();
            const div = document.createElement('div');
            div.className = `msg ${msg.sender === 'admin' ? 'msg-admin' : 'msg-user'}`;
            div.innerText = msg.text;
            box.appendChild(div);
          });
          box.scrollTop = box.scrollHeight;
        });
    }

    function sendReply() {
      const inp = document.getElementById('adminInput');
      const txt = inp.value.trim();
      if(!txt || !currentChatId) return;
      
      if (currentUserData && currentUserData.isBlocked) {
        alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Ñ");
        return;
      }
      
      db.collection('chats').doc(currentChatId).collection('messages').add({
        text: txt, sender: 'admin', timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      db.collection('chats').doc(currentChatId).set({
        lastMessage: 'Admin: ' + txt,
        lastActive: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
      inp.value = '';
    }

    function handleEnter(e) { if(e.key === 'Enter') sendReply(); }
    
    // üî• --- [NEW] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Custom Modal --- üî•
    
    /** ‡∏õ‡∏¥‡∏î Modal */
    function closeModal(id) {
      document.getElementById(id).style.display = 'none';
      confirmAction = null; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå action ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î
    }

    /** ‡πÅ‡∏™‡∏î‡∏á Modal */
    function showConfirmModal(title, desc, icon, onConfirm) {
      document.getElementById('confirmTitle').innerText = title;
      document.getElementById('confirmDesc').innerText = desc;
      document.getElementById('confirmIcon').innerHTML = icon;
      
      // 1. ‡πÄ‡∏Å‡πá‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏£‡∏±‡∏ô‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£
      confirmAction = () => {
        onConfirm(); // ‡∏£‡∏±‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
        closeModal('confirmModal'); // ‡∏õ‡∏¥‡∏î Modal
      };
      
      // 2. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏° "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô" ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ confirmAction
      document.getElementById('btnConfirmAction').onclick = confirmAction;
      
      // 3. ‡πÅ‡∏™‡∏î‡∏á Modal
      document.getElementById('confirmModal').style.display = 'flex';
    }


    /** ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏•‡πá‡∏≠‡∏Ñ */
    function updateBlockButtonState(isBlocked) {
      const blockBtn = document.getElementById('blockBtn');
      if (isBlocked) {
        blockBtn.innerHTML = '<i class="fas fa-check-circle"></i> ‡∏õ‡∏•‡∏î‡∏ö‡∏•‡πá‡∏≠‡∏Ñ';
        blockBtn.classList.add('is-blocked');
      } else {
        blockBtn.innerHTML = '<i class="fas fa-ban"></i> ‡∏ö‡∏•‡πá‡∏≠‡∏Ñ';
        blockBtn.classList.remove('is-blocked');
      }
    }

    /** üî• [MODIFIED] ‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡∏ö‡∏•‡πá‡∏≠‡∏Ñ/‡∏õ‡∏•‡∏î‡∏ö‡∏•‡πá‡∏≠‡∏Ñ (‡πÉ‡∏ä‡πâ Modal) */
    async function toggleBlockUser() {
      if (!currentChatId || !currentUserData) return;

      const newBlockedState = !currentUserData.isBlocked; // ‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
      const actionText = newBlockedState ? '‡∏ö‡∏•‡πá‡∏≠‡∏Ñ' : '‡∏õ‡∏•‡∏î‡∏ö‡∏•‡πá‡∏≠‡∏Ñ';
      const displayName = currentUserData.displayName || (currentUserData.email ? currentUserData.email.split('@')[0] : '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ');
      
      // üî• [NEW] 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å (‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏£‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô)
      const doBlockLogic = async () => {
        try {
          // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ô Firestore
          await db.collection('chats').doc(currentChatId).set({
            isBlocked: newBlockedState
          }, { merge: true });

          // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
          currentUserData.isBlocked = newBlockedState; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï state ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
          updateBlockButtonState(newBlockedState);
          document.getElementById('adminInput').disabled = newBlockedState;
          document.getElementById('sendBtn').disabled = newBlockedState;

          // (‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å) ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó
          const adminMsg = newBlockedState ? '‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏ö‡∏•‡πá‡∏≠‡∏Ñ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ' : '‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏õ‡∏•‡∏î‡∏ö‡∏•‡πá‡∏≠‡∏Ñ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ';
          db.collection('chats').doc(currentChatId).collection('messages').add({
            text: `[‡∏£‡∏∞‡∏ö‡∏ö] ${adminMsg}`,
            sender: 'admin',
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });

        } catch (err) {
          console.error("Error toggling block state: ", err);
          alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ ${actionText}`);
        }
      };
      
      // üî• [NEW] 2. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Custom Modal ‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏ñ‡∏≤‡∏°
      showConfirmModal(
        `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£ ${actionText}`, // Title
        `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ${actionText} ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ${displayName} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`, // Description
        newBlockedState ? 'üö´' : '‚úÖ', // Icon
        doBlockLogic // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏£‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
      );
    }
    
  </script>
</body>
</html>
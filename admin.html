<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Mitr:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    /* (CSS ‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) */
    body { font-family: 'Mitr', sans-serif; margin: 0; display: flex; height: 100vh; background: #f0f2f5; font-size: 16px; }
    .sidebar { width: 320px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
    .sidebar-header {
      padding: 0; background: #7A56D3; color: white; font-weight: 600; 
      display: flex; flex-direction: column; align-items: stretch; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 10;
    }
    .sidebar-header-top { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; }
    .sidebar-tabs { display: flex; background: #6a4abf; }
    .tab-btn { flex: 1; text-align: center; padding: 12px 10px; cursor: pointer; color: rgba(255,255,255,0.7); transition: 0.2s; font-weight: 500; border-bottom: 3px solid transparent; font-size: 0.95rem; }
    .tab-btn:hover { background: rgba(0,0,0,0.1); }
    .tab-btn.active { color: white; border-bottom: 3px solid #ffe13c; }
    .user-list { flex: 1; overflow-y: auto; flex-direction: column; }
    .user-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.2s; }
    .user-item:hover { background: #F3F0FF; }
    .user-item.active { background: #E9E4FF; border-left: 5px solid #7A56D3; }
    .user-avatar { width: 45px; height: 45px; background: #eee; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: #888; font-size: 1.2rem; flex-shrink: 0; overflow: hidden; }
    .user-avatar-img { width: 100%; height: 100%; object-fit: cover; }
    .user-info { flex: 1; min-width: 0; }
    .user-name { font-weight: 600; color: #333; font-size: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-preview { font-size: 0.9rem; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-time { font-size: 0.75rem; color: #aaa; margin-top: 2px; }
    .blocked-tag { font-size: 0.8rem; color: #d93025; font-weight: 600; margin-left: 5px; }
    .coupon-list { flex: 1; overflow-y: auto; display: none; }
    .coupon-list-header {
      padding: 15px;
      background: #f9f9f9;
      border-bottom: 1px solid #ddd;
      display: flex; 
      flex-direction: column; 
      gap: 10px; 
    }
    .reset-all-btn {
      width: 100%;
      background: #d93025;
      color: white;
      border: none;
      padding: 12px;
      border-radius: 5px;
      cursor: pointer;
      font-family: 'Mitr', sans-serif;
      font-size: 1rem;
      font-weight: 600;
      transition: 0.2s;
    }
    .reset-all-btn:hover { background: #b0271e; }
    .reset-all-btn:disabled { background: #ccc; }
    .reset-all-login-claims-btn {
      width: 100%;
      background: #007bff; 
      color: white;
      border: none;
      padding: 12px;
      border-radius: 5px;
      cursor: pointer;
      font-family: 'Mitr', sans-serif;
      font-size: 1rem;
      font-weight: 600;
      transition: 0.2s;
    }
    .reset-all-login-claims-btn:hover { background: #0056b3; }
    .reset-all-login-claims-btn:disabled { background: #ccc; }
    .coupon-item { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; gap: 10px; }
    .coupon-info { font-size: 0.9rem; }
    .coupon-info strong { font-size: 1.1rem; color: #7A56D3; display: block; }
    .reset-coupon-btn { background: #ff424f; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-family: 'Mitr', sans-serif; font-size: 0.9rem; transition: 0.2s; flex-shrink: 0; }
    .reset-coupon-btn:hover { background: #d93025; }
    .reset-coupon-btn:disabled { background: #ccc; }
    .chat-area { flex: 1; display: flex; flex-direction: column; background: #fff; }
    .chat-area-header { padding: 15px 20px; border-bottom: 1px solid #ddd; font-weight: 600; background: #f9f9f9; display: flex; align-items: center; justify-content: flex-start; gap: 15px; }
    .header-avatar-container { width: 40px; height: 40px; background: #eee; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.8rem; color: #ccc; overflow: hidden; flex-shrink: 0; }
    .header-avatar-container img { width: 100%; height: 100%; object-fit: cover; }
    .chat-header-actions { display: flex; gap: 10px; margin-left: auto; }
    .reset-login-coupon-btn { padding: 8px 15px; border: none; border-radius: 5px; background: #007bff; color: white; cursor: pointer; font-family: 'Mitr', sans-serif; font-weight: 600; font-size: 0.9rem; transition: 0.2s; }
    .reset-login-coupon-btn:hover { background: #0056b3; }
    .block-btn { padding: 8px 15px; border: none; border-radius: 5px; background: #d93025; color: white; cursor: pointer; font-family: 'Mitr', sans-serif; font-weight: 600; font-size: 0.9rem; transition: 0.2s; }
    .block-btn:hover { background: #b0271e; }
    .block-btn.is-blocked { background: #f0ad4e; }
    .block-btn.is-blocked:hover { background: #df9e3c; }
    .delete-btn { padding: 8px 15px; border: none; border-radius: 5px; background: #6c757d; color: white; cursor: pointer; font-family: 'Mitr', sans-serif; font-weight: 600; font-size: 0.9rem; transition: 0.2s; }
    .delete-btn:hover { background: #5a6268; }
    .messages-box { flex: 1; padding: 20px; overflow-y: auto; background: #fff; display: flex; flex-direction: column; gap: 10px; }
    .input-box { padding: 20px; border-top: 1px solid #ddd; display: flex; gap: 10px; background: #f0f0f0; }
    .input-box input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 25px; outline: none; padding-left: 20px; font-family: 'Mitr', sans-serif; font-size: 1rem; }
    .input-box button { padding: 10px 25px; background: #7A56D3; color: white; border: none; border-radius: 25px; cursor: pointer; font-weight: 600; transition: 0.2s; font-family: 'Mitr', sans-serif; }
    .input-box button:hover { background: #5E42A6; }
    .input-box button:disabled { background: #ccc; cursor: not-allowed; }
    .msg { padding: 10px 15px; border-radius: 15px; max-width: 70%; word-wrap: break-word; line-height: 1.4; position: relative; animation: fadeIn 0.2s; font-size: 1rem; }
    @keyframes fadeIn { from{opacity:0; transform:translateY(5px);} to{opacity:1; transform:translateY(0);} }
    .msg-admin { background: #7A56D3; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
    .msg-user { background: #f1f1f1; color: #333; align-self: flex-start; border-bottom-left-radius: 2px; }
    .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #ccc; }
    .empty-state i { font-size: 3rem; margin-bottom: 10px; }
    
    /* (Modal CSS) */
    .modal { 
      display: none; position: fixed; top: 0; left: 0; 
      width: 100%; height: 100%; background: rgba(0,0,0,0.5); 
      z-index: 1000; justify-content: center; align-items: center; 
    }
    .confirm-modal-box { 
      background: white; padding: 25px; border-radius: 10px; 
      text-align: center; width: 90%; max-width: 350px; 
      animation: popIn 0.3s; 
    }
    @keyframes popIn { 
      from { transform: scale(0.8); opacity: 0; } 
      to { transform: scale(1); opacity: 1; } 
    }
    .confirm-icon { font-size: 3rem; margin-bottom: 15px; display: block; }
    .confirm-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; color: #333; }
    .confirm-desc { font-size: 0.95rem; color: #666; margin-bottom: 20px; }
    .confirm-actions { display: flex; gap: 10px; justify-content: center; }
    .btn-confirm-action { 
      flex: 1; padding: 10px; border: none; 
      border-radius: 5px; cursor: pointer; 
      font-family: 'Mitr'; font-weight: 600; 
    }
    .btn-yes { background: #7A56D3; color: white; }
    .btn-no { background: #eee; color: #333; }
    
    /* ‚≠êÔ∏è [‡πÉ‡∏´‡∏°‡πà] CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° "‡∏ï‡∏Å‡∏•‡∏á" ‡πÅ‡∏•‡∏∞‡∏™‡πÑ‡∏ï‡∏•‡πå Error ‚≠êÔ∏è */
    .btn-ok { 
      background: #4CAF50; 
      color: white; 
      width: 100%; 
    }
    .btn-ok:hover {
      background: #45a049;
    }
    #alertModal.is-error .confirm-icon {
      color: #d93025;
    }
    #alertModal.is-error .btn-ok {
      background: #d93025;
    }
    #alertModal.is-error .btn-ok:hover {
      background: #b0271e;
    }
    /* ‚≠êÔ∏è [‡∏à‡∏ö] ‚≠êÔ∏è */

  </style>
</head>
<body>

  <div class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-header-top">
        <span style="font-weight: 600; font-size: 1.1rem;">Admin Panel</span>
        <small style="cursor:pointer; font-size:0.85rem; opacity:0.8;" onclick="location.reload()"><i class="fas fa-sync"></i> ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î</small>
      </div>
      <div class="sidebar-tabs">
          <div class="tab-btn active" onclick="switchAdminTab('chat', this)">
              <i class="fas fa-comments"></i> ‡πÅ‡∏ä‡∏ó
          </div>
          <div class="tab-btn" onclick="switchAdminTab('coupons', this)">
              <i class="fas fa-ticket-alt"></i> ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á
          </div>
      </div>
    </div>
    <div class="user-list" id="userList" style="display: flex;">
      <div style="padding:20px; text-align:center; color:#999;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠...</div>
    </div>
    
    <div class="coupon-list" id="couponList">
      <div class="coupon-list-header">
          <button class="reset-all-login-claims-btn" id="resetAllLoginClaimsBtn" onclick="confirmResetAllLoginClaims()">
              <i class="fas fa-gift"></i> ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
          </button>
          
          <button class="reset-all-btn" id="resetAllBtn" onclick="confirmResetAllCoupons()">
              <i class="fas fa-history"></i> ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
          </button>
      </div>
      </div>
  </div>

  <div class="chat-area">
    <div class="chat-area-header">
      <div class="header-avatar-container" id="chatHeaderAvatar">
        <i class="far fa-comment-dots" style="font-size: 1.5rem;"></i>
      </div>
      <div>
        <span id="chatHeaderName" style="display: block; line-height: 1.2;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ä‡∏ó‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏ô‡∏ó‡∏ô‡∏≤</span>
        <span id="chatHeaderId" style="font-size:0.9rem; color:#999; font-weight:normal;"></span>
      </div>
      
      <div class="chat-header-actions" id="chatActions" style="display: none;">
        <button id="resetLoginCouponBtn" onclick="confirmResetLoginCoupon()" class="reset-login-coupon-btn">
            <i class="fas fa-ticket-alt"></i> ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÇ‡∏Ñ‡πâ‡∏î (‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ)
        </button>
        <button id="blockBtn" onclick="toggleBlockUser()" class="block-btn">
          <i class="fas fa-ban"></i> ‡∏ö‡∏•‡πá‡∏≠‡∏Ñ
        </button>
        <button id="deleteBtn" onclick="confirmDeleteChat()" class="delete-btn">
          <i class="fas fa-trash-alt"></i> ‡∏•‡∏ö‡πÅ‡∏ä‡∏ó
        </button>
      </div>
    </div>
    <div class="messages-box" id="messagesBox">
      <div class="empty-state">
        <i class="far fa-comment-dots"></i>
        <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏ó</p>
      </div>
    </div>
    <div class="input-box">
      <input type="text" id="adminInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö..." disabled onkeypress="handleEnter(event)">
      <button id="sendBtn" onclick="sendReply()" disabled><i class="fas fa-paper-plane"></i> ‡∏™‡πà‡∏á</button>
    </div>
  </div>

  <div id="confirmModal" class="modal">
    <div class="confirm-modal-box">
      <div id="confirmIcon" class="confirm-icon">‚ùì</div>
      <div id="confirmTitle" class="confirm-title">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô?</div>
      <div id="confirmDesc" class="confirm-desc">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...</div>
      <div class="confirm-actions">
        <button class="btn-confirm-action btn-no" onclick="closeModal('confirmModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="btn-confirm-action btn-yes" id="btnConfirmAction">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
      </div>
    </div>
  </div>
  
  <div id="alertModal" class="modal" style="align-items: center;">
    <div class="confirm-modal-box">
      <div id="alertIcon" class="confirm-icon">‚úÖ</div>
      <div id="alertTitle" class="confirm-title">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div>
      <div id="alertDesc" class="confirm-desc">‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</div>
      <div class="confirm-actions">
        <button class="btn-confirm-action btn-ok" onclick="closeModal('alertModal')">‡∏ï‡∏Å‡∏•‡∏á</button>
      </div>
    </div>
  </div>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>


  <script>
    // --- (Firebase Config ... ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
    const firebaseConfig = {
      apiKey: "AIzaSyA7lELq82KxJ0sFDf6jKmWPDFKpKqHJp0c",
      authDomain: "king007-c72e2.firebaseapp.com",
      projectId: "king007-c72e2",
      storageBucket: "king007-c72e2.firebasestorage.app",
      messagingSenderId: "136587774092",
      appId: "1:136587774092:web:4ee67ff03cdee67bb393a9",
      measurementId: "G-K39CYF7766"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth(); 

    // (Global Variables ... ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    let currentChatId = null;
    let unsubscribeMsg = null;
    let currentUserData = null; 
    let confirmAction = null;
    let unsubscribeCoupons = null;

    // (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ä‡∏ó ... ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    db.collection('chats').orderBy('lastActive', 'desc').onSnapshot(snapshot => {
      const userList = document.getElementById('userList');
      const users = [];
      snapshot.forEach(doc => { users.push({ id: doc.id, ...doc.data() }); });
      
      if (currentChatId) {
        const updatedCurrentUserData = users.find(u => u.id === currentChatId);
        if (updatedCurrentUserData) {
          currentUserData = updatedCurrentUserData; 
          updateBlockButtonState(currentUserData.isBlocked); 
          document.getElementById('adminInput').disabled = currentUserData.isBlocked || false;
          document.getElementById('sendBtn').disabled = currentUserData.isBlocked || false;
        } else {
            resetChatUI();
        }
      }
      
      userList.innerHTML = '';
      if (users.length === 0) {
        userList.innerHTML = '<div style="padding:30px; text-align:center; color:#ccc;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡∏Å‡∏°‡∏≤</div>';
        return;
      }

      users.forEach(u => {
        const div = document.createElement('div');
        div.className = `user-item ${currentChatId === u.id ? 'active' : ''}`;
        div.onclick = () => selectChat(u, div); 
        
        let timeStr = "";
        if(u.lastActive) {
          const date = u.lastActive.toDate();
          timeStr = date.getHours() + ":" + date.getMinutes().toString().padStart(2, '0');
        }
        
        const displayName = u.displayName || (u.email ? u.email.split('@')[0] : `Guest (${u.id.substr(0,4)})`);
        const avatarImg = u.photoURL ? `<img src="${u.photoURL}" class="user-avatar-img">` : `<i class="fas fa-user"></i>`;
        const blockedIndicator = u.isBlocked ? '<span class="blocked-tag">(‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Ñ)</span>' : '';

        div.innerHTML = `
          <div class="user-avatar">${avatarImg}</div>
          <div class="user-info">
            <div style="display:flex; justify-content:space-between;">
              <div class="user-name">${displayName}${blockedIndicator}</div>
              <div class="user-time">${timeStr}</div>
            </div>
            <div class="user-preview">${u.lastMessage || '‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û/‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå'}</div>
          </div>
        `;
        userList.appendChild(div);
      });
    });

    // (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô selectChat ... ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    function selectChat(u, element) { 
      if (document.getElementById('userList').style.display === 'none') {
          document.getElementById('userList').style.display = 'flex';
          document.getElementById('couponList').style.display = 'none';
          const tabs = document.querySelectorAll('.tab-btn');
          if (tabs.length > 1) {
              tabs[0].classList.add('active');
              tabs[1].classList.remove('active');
          }
      }
      currentChatId = u.id;
      currentUserData = u; 
      document.querySelectorAll('.user-item').forEach(e => e.classList.remove('active'));
      element.classList.add('active');
      const avatarHeader = document.getElementById('chatHeaderAvatar');
      if (u.photoURL) {
        avatarHeader.innerHTML = `<img src="${u.photoURL}" alt="avatar">`;
      } else {
        avatarHeader.innerHTML = `<i class="fas fa-user-circle" style="font-size: 1.8rem; color: #ccc;"></i>`;
      }
      const displayName = u.displayName || (u.email ? u.email.split('@')[0] : `Guest (${u.id.substr(0,4)})`);
      document.getElementById('chatHeaderName').innerText = displayName;
      document.getElementById('chatHeaderId').innerText = `(ID: ${u.id})`;
      document.getElementById('chatActions').style.display = 'flex'; 
      updateBlockButtonState(u.isBlocked);
      const resetLoginBtn = document.getElementById('resetLoginCouponBtn');
      if (u.id.startsWith('guest_')) {
          resetLoginBtn.style.display = 'none';
      } else {
          resetLoginBtn.style.display = 'block';
      }
      document.getElementById('adminInput').disabled = u.isBlocked || false;
      document.getElementById('sendBtn').disabled = u.isBlocked || false;
      if(unsubscribeMsg) unsubscribeMsg();
      const box = document.getElementById('messagesBox');
      unsubscribeMsg = db.collection('chats').doc(u.id).collection('messages')
        .orderBy('timestamp')
        .onSnapshot(snap => {
          box.innerHTML = '';
          if(snap.empty) {
            box.innerHTML = '<div class="empty-state"><p>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</p></div>';
            return;
          }
          snap.forEach(doc => {
            const msg = doc.data();
            const div = document.createElement('div');
            div.className = `msg ${msg.sender === 'admin' ? 'msg-admin' : 'msg-user'}`;
            div.innerText = msg.text;
            box.appendChild(div);
          });
          box.scrollTop = box.scrollHeight;
        });
    }

    // ‚≠êÔ∏è [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô sendReply (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô alert) ‚≠êÔ∏è
    function sendReply() {
      const inp = document.getElementById('adminInput');
      const txt = inp.value.trim();
      if(!txt || !currentChatId) return;
      
      if (currentUserData && currentUserData.isBlocked) {
        // üëà [‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô]
        showAlert("‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Ñ", true);
        return;
      }
      
      db.collection('chats').doc(currentChatId).collection('messages').add({
        text: txt, sender: 'admin', timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      db.collection('chats').doc(currentChatId).set({
        lastMessage: 'Admin: ' + txt,
        lastActive: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
      inp.value = '';
    }

    function handleEnter(e) { if(e.key === 'Enter') sendReply(); }
    
    // (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Modal Yes/No ... ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    function closeModal(id) {
      document.getElementById(id).style.display = 'none';
      confirmAction = null; 
    }
    function showConfirmModal(title, desc, icon, onConfirm) {
      document.getElementById('confirmTitle').innerText = title;
      document.getElementById('confirmDesc').innerText = desc;
      document.getElementById('confirmIcon').innerHTML = icon;
      confirmAction = () => {
        onConfirm(); 
        closeModal('confirmModal'); 
      };
      document.getElementById('btnConfirmAction').onclick = confirmAction;
      document.getElementById('confirmModal').style.display = 'flex';
    }
    
    // ‚≠êÔ∏è [‡πÉ‡∏´‡∏°‡πà] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Modal Alert (OK) ‚≠êÔ∏è
    function showAlert(title, desc, isError = false) {
        const modal = document.getElementById('alertModal');
        const iconEl = document.getElementById('alertIcon');
        const titleEl = document.getElementById('alertTitle');
        const descEl = document.getElementById('alertDesc');
        
        titleEl.innerText = title;
        descEl.innerText = desc;
        
        if (isError) {
            iconEl.innerHTML = 'üö´';
            modal.classList.add('is-error');
        } else {
            iconEl.innerHTML = '‚úÖ';
            modal.classList.remove('is-error');
        }
        
        modal.style.display = 'flex';
    }
    // ‚≠êÔ∏è [‡∏à‡∏ö] ‚≠êÔ∏è

    // (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô updateBlockButtonState ... ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    function updateBlockButtonState(isBlocked) {
      const blockBtn = document.getElementById('blockBtn');
      if (isBlocked) {
        blockBtn.innerHTML = '<i class="fas fa-check-circle"></i> ‡∏õ‡∏•‡∏î‡∏ö‡∏•‡πá‡∏≠‡∏Ñ';
        blockBtn.classList.add('is-blocked');
      } else {
        blockBtn.innerHTML = '<i class="fas fa-ban"></i> ‡∏ö‡∏•‡πá‡∏≠‡∏Ñ';
        blockBtn.classList.remove('is-blocked');
      }
    }
    
    // ‚≠êÔ∏è [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô toggleBlockUser (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô alert) ‚≠êÔ∏è
    async function toggleBlockUser() {
      if (!currentChatId || !currentUserData) return;
      const newBlockedState = !currentUserData.isBlocked; 
      const actionText = newBlockedState ? '‡∏ö‡∏•‡πá‡∏≠‡∏Ñ' : '‡∏õ‡∏•‡∏î‡∏ö‡∏•‡πá‡∏≠‡∏Ñ';
      const displayName = currentUserData.displayName || (currentUserData.email ? currentUserData.email.split('@')[0] : '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ');
      
      const doBlockLogic = async () => {
        try {
          await db.collection('chats').doc(currentChatId).set({
            isBlocked: newBlockedState
          }, { merge: true });
          currentUserData.isBlocked = newBlockedState; 
          updateBlockButtonState(newBlockedState);
          document.getElementById('adminInput').disabled = newBlockedState;
          document.getElementById('sendBtn').disabled = newBlockedState;
          const adminMsg = newBlockedState ? '‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏ö‡∏•‡πá‡∏≠‡∏Ñ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ' : '‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏õ‡∏•‡∏î‡∏ö‡∏•‡πá‡∏≠‡∏Ñ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ';
          db.collection('chats').doc(currentChatId).collection('messages').add({
            text: `[‡∏£‡∏∞‡∏ö‡∏ö] ${adminMsg}`,
            sender: 'admin',
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
        } catch (err) {
          console.error("Error toggling block state: ", err);
          // üëà [‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô]
          showAlert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î`, `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ ${actionText}`, true);
        }
      };
      showConfirmModal(
        `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£ ${actionText}`, 
        `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ${actionText} ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ${displayName} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`, 
        newBlockedState ? 'üö´' : '‚úÖ', 
        doBlockLogic 
      );
    }
    
    // (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô confirmResetLoginCoupon ... ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    function confirmResetLoginCoupon() {
        if (!currentChatId || !currentUserData || currentChatId.startsWith('guest_')) return;
        
        const displayName = currentUserData.displayName || (currentUserData.email ? currentUserData.email.split('@')[0] : '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ');
        
        showConfirmModal(
            'üéüÔ∏è ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÇ‡∏Ñ‡πâ‡∏î Login?',
            `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î MEMBER50 ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö ${displayName} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏∞‡∏Å‡∏î‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á)`,
            'üéüÔ∏è',
            resetLoginCoupon
        );
    }

    // ‚≠êÔ∏è [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô resetLoginCoupon (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô alert) ‚≠êÔ∏è
    async function resetLoginCoupon() {
        if (!currentChatId) return;
        
        try {
            await db.collection('users').doc(currentChatId).set({
                hasClaimedMemberCoupon: false
            }, { merge: true });

            db.collection('chats').doc(currentChatId).collection('messages').add({
                text: `[‡∏£‡∏∞‡∏ö‡∏ö] ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î Login (MEMBER50) ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß`,
                sender: 'admin',
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // üëà [‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô]
            showAlert('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏î‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î MEMBER50 ‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');

        } catch (err) {
            console.error("Error resetting login coupon:", err);
            // üëà [‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô]
            showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', err.message, true);
        }
    }

    // (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô switchAdminTab ... ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    function switchAdminTab(tabName, element) {
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        element.classList.add('active');

        if (tabName === 'chat') {
            document.getElementById('userList').style.display = 'flex';
            document.getElementById('couponList').style.display = 'none';
            if (unsubscribeCoupons) unsubscribeCoupons(); 
        } else if (tabName === 'coupons') {
            document.getElementById('userList').style.display = 'none';
            document.getElementById('couponList').style.display = 'block';
            loadCoupons(); 
        }
    }
    
    // (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô loadCoupons ... ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    function loadCoupons() {
        const listEl = document.getElementById('couponList');
        
        let itemsContainer = document.getElementById('couponItemsContainer');
        if (!itemsContainer) {
            itemsContainer = document.createElement('div');
            itemsContainer.id = 'couponItemsContainer';
            listEl.appendChild(itemsContainer);
        }
        
        itemsContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á...</div>';
        
        if (unsubscribeCoupons) unsubscribeCoupons(); 

        unsubscribeCoupons = db.collection('coupons').onSnapshot(snapshot => {
            if (snapshot.empty) {
                itemsContainer.innerHTML = '<div style="padding:30px; text-align:center; color:#ccc;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á (‡πÑ‡∏õ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà Firestore)</div>';
                return;
            }

            itemsContainer.innerHTML = ''; 
            snapshot.forEach(doc => {
                const coupon = doc.data();
                const couponId = doc.id;
                
                const div = document.createElement('div');
                div.className = 'coupon-item';
                
                const usage = `${coupon.quantityUsed || 0} / ${coupon.quantityAvailable || 'N/A'}`;
                const limit = coupon.limitPerUser || 1;
                
                div.innerHTML = `
                    <div class="coupon-info">
                        <strong>${couponId}</strong>
                        <span>‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${usage}</span>
                        <small style="display: block; color: #888;">(1 ‡∏Ñ‡∏ô‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ ${limit} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</small>
                    </div>
                    <button class="reset-coupon-btn" id="reset-${couponId}" onclick="confirmResetCoupon('${couponId}')">
                        <i class="fas fa-history"></i> ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
                    </button>
                `;
                itemsContainer.appendChild(div);
            });
        }, err => {
            console.error("Error loading coupons:", err);
            itemsContainer.innerHTML = '<div style="padding:30px; text-align:center; color:red;">‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</div>';
        });
    }

    // (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô confirmResetCoupon ... ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    function confirmResetCoupon(couponId) {
        showConfirmModal(
            '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á',
            `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á "${couponId}" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÅ‡∏•‡∏∞‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á)`,
            '‚ö†Ô∏è',
            () => { 
                resetCoupon(couponId);
            }
        );
    }
    
    // ‚≠êÔ∏è [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô resetCoupon (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô alert) ‚≠êÔ∏è
    async function resetCoupon(couponId) {
        const btn = document.getElementById(`reset-${couponId}`);
        if(btn) btn.disabled = true;

        try {
            const couponRef = db.collection('coupons').doc(couponId);
            
            await couponRef.update({
                quantityUsed: 0
            });

            const usageRef = couponRef.collection('usersWhoUsed');
            const snapshot = await usageRef.get();
            
            if (!snapshot.empty) {
                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
            }
            
            console.log(`Coupon ${couponId} has been reset.`);
            // üëà [‡πÉ‡∏´‡∏°‡πà] ‡πÄ‡∏û‡∏¥‡πà‡∏° Alert ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            showAlert('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á ${couponId} ‡∏ñ‡∏π‡∏Å‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);

        } catch (err) {
            console.error("Error resetting coupon:", err);
            // üëà [‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô]
            showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï: ${err.message}`, true);
        } finally {
            if(btn) btn.disabled = false;
        }
    }

    // (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô confirmResetAllCoupons ... ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    function confirmResetAllCoupons() {
        showConfirmModal(
            'üî• ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î? üî•',
            `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á *‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î* ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á *‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô* ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏´‡πâ *‡∏ó‡∏∏‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î* (‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ)`,
            'üî•',
            resetAllCoupons
        );
    }

    // ‚≠êÔ∏è [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô resetAllCoupons (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô alert) ‚≠êÔ∏è
    async function resetAllCoupons() {
        const btn = document.getElementById('resetAllBtn');
        btn.disabled = true;
        btn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï...';

        try {
            const couponsSnapshot = await db.collection('coupons').get();
            if (couponsSnapshot.empty) {
                // üëà [‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô]
                showAlert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö', true);
                return;
            }

            let resetCount = 0;
            await Promise.all(couponsSnapshot.docs.map(async (doc) => {
                const couponId = doc.id;
                console.log(`Resetting ${couponId}...`);
                
                const couponRef = db.collection('coupons').doc(couponId);
                const usageRef = couponRef.collection('usersWhoUsed');
                const usageSnapshot = await usageRef.get();
                const batch = db.batch();
                batch.update(couponRef, { quantityUsed: 0 });
                if (!usageSnapshot.empty) {
                    usageSnapshot.docs.forEach(usageDoc => {
                        batch.delete(usageDoc.ref);
                    });
                }
                await batch.commit();
                resetCount++;
            }));

            // üëà [‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô]
            showAlert('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${resetCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!`);

        } catch (err) {
            console.error("Error resetting all coupons:", err);
            // üëà [‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô]
            showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', err.message, true);
        } finally {
            btn.disabled = false;
            btn.innerText = '‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)';
        }
    }
    
    // (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô confirmResetAllLoginClaims ... ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    function confirmResetAllLoginClaims() {
        showConfirmModal(
            'üéÅ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?',
            `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ *‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô* ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å" (MEMBER50) ‡πÑ‡∏î‡πâ *‡πÉ‡∏´‡∏°‡πà* ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡∏à‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏Å‡∏î‡∏£‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß)`,
            'üéÅ',
            resetAllLoginClaims
        );
    }

    // ‚≠êÔ∏è [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô resetAllLoginClaims (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô alert) ‚≠êÔ∏è
    async function resetAllLoginClaims() {
        const btn = document.getElementById('resetAllLoginClaimsBtn');
        btn.disabled = true;
        btn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå...';

        try {
            const usersQuery = db.collection('users').where('hasClaimedMemberCoupon', '==', true);
            const snapshot = await usersQuery.get();

            if (snapshot.empty) {
                // üëà [‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô]
                showAlert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï (‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏¢‡∏±‡∏á‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏î‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)');
                return;
            }
            
            console.log(`‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ${snapshot.size} ‡∏Ñ‡∏ô ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï...`);
            
            let batch = db.batch();
            let commitPromises = [];
            let i = 0;

            for (const doc of snapshot.docs) {
                batch.update(doc.ref, { hasClaimedMemberCoupon: false });
                i++;
                if (i % 499 === 0) {
                    console.log(`‡∏Å‡∏≥‡∏•‡∏±‡∏á commit batch ‡∏ó‡∏µ‡πà ${i}...`);
                    commitPromises.push(batch.commit());
                    batch = db.batch();
                }
            }
            commitPromises.push(batch.commit());
            await Promise.all(commitPromises);

            // üëà [‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô]
            showAlert('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ${snapshot.size} ‡∏Ñ‡∏ô ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!`);

        } catch (err) {
            console.error("Error resetting all login claims:", err);
            // üëà [‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô]
            showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', err.message, true);
        } finally {
            btn.disabled = false;
            btn.innerText = '‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)';
        }
    }
    
    // (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô resetChatUI, confirmDeleteChat ... ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    function resetChatUI() {
        currentChatId = null; currentUserData = null;
        if (unsubscribeMsg) unsubscribeMsg(); unsubscribeMsg = null;
        document.getElementById('messagesBox').innerHTML = `<div class="empty-state"><i class="far fa-comment-dots"></i><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏ó</p></div>`;
        document.getElementById('chatHeaderName').innerText = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ä‡∏ó‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏ô‡∏ó‡∏ô‡∏≤';
        document.getElementById('chatHeaderId').innerText = '';
        document.getElementById('chatActions').style.display = 'none'; 
        document.getElementById('adminInput').disabled = true;
        document.getElementById('sendBtn').disabled = true;
        document.querySelectorAll('.user-item').forEach(e => e.classList.remove('active'));
    }
    function confirmDeleteChat() {
        if (!currentChatId || !currentUserData) return;
        const displayName = currentUserData.displayName || (currentUserData.email ? currentUserData.email.split('@')[0] : '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ');
        showConfirmModal( 'üóëÔ∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÅ‡∏ä‡∏ó', `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÅ‡∏ä‡∏ó‡∏Ç‡∏≠‡∏á ${displayName} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î *‡∏ñ‡∏≤‡∏ß‡∏£* ‡∏ó‡∏±‡πâ‡∏á‡∏ù‡∏±‡πà‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ`, 'üóëÔ∏è', deleteChat );
    }

    // ‚≠êÔ∏è [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô deleteChat (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô alert) ‚≠êÔ∏è
    async function deleteChat() {
        if (!currentChatId) return;
        
        const chatIdToDelete = currentChatId;
        const chatDisplayName = currentUserData.displayName || '‡πÅ‡∏ä‡∏ó';

        resetChatUI(); 

        try {
            console.log(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏ö‡πÅ‡∏ä‡∏ó: ${chatIdToDelete}`);
            const messagesRef = db.collection('chats').doc(chatIdToDelete).collection('messages');
            
            await deleteCollection(messagesRef, 500);
            await db.collection('chats').doc(chatIdToDelete).delete();

            console.log(`‡πÅ‡∏ä‡∏ó ${chatIdToDelete} (${chatDisplayName}) ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß`);
            // üëà [‡πÉ‡∏´‡∏°‡πà] ‡πÄ‡∏û‡∏¥‡πà‡∏° Alert ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            showAlert('‡∏•‡∏ö‡πÅ‡∏ä‡∏ó‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡πÅ‡∏ä‡∏ó‡∏Ç‡∏≠‡∏á ${chatDisplayName} ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß`);

        } catch (err) {
            console.error("Error deleting chat:", err);
            // üëà [‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô]
            showAlert('‡∏•‡∏ö‡πÅ‡∏ä‡∏ó‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', err.message, true);
        }
    }

    // (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô deleteCollection, deleteQueryBatch ... ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    async function deleteCollection(collectionRef, batchSize) {
        const query = collectionRef.limit(batchSize);
        return new Promise((resolve, reject) => {
            deleteQueryBatch(query, resolve, reject);
        });
    }
    async function deleteQueryBatch(query, resolve, reject) {
        try {
            const snapshot = await query.get();
            if (snapshot.size === 0) {
                return resolve();
            }
            const batch = db.batch();
            snapshot.docs.forEach(doc => {
                batch.delete(doc.ref);
            });
            await batch.commit();
            setTimeout(() => {
                deleteQueryBatch(query, resolve, reject);
            }, 0);
        } catch (err) {
            reject(err);
        }
    }

  </script>
</body>
</html>